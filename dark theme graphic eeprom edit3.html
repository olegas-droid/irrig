<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irrigation Control System</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #e0e0e0; padding: 10px; line-height: 1.5; }
        .header { background: linear-gradient(135deg, #1a1a1a, #2a2a2a); color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .status-card { background: #1a1a1a; padding: 12px; border-radius: 8px; font-size: 14px; border: 1px solid #333; transition: all 0.3s ease; }
        .status-card:hover { background: #252525; transform: translateY(-2px); }
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .quick-btn { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .quick-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        .btn-green { background: #27ae60; color: white; }
        .btn-green:hover { background: #2ecc71; }
        .btn-red { background: #c0392b; color: white; }
        .btn-red:hover { background: #e74c3c; }
        .btn-gray { background: #34495e; color: white; }
        .btn-gray:hover { background: #4a6b8a; }
        .tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
        .tab { padding: 12px; border: 1px solid #333; background: #1a1a1a; border-radius: 8px; font-size: 14px; color: #e0e0e0; cursor: pointer; transition: all 0.3s ease; }
        .tab:hover { background: #2a2a2a; }
        .tab.active { background: #3498db; color: white; border-color: #3498db; }
        .tabcontent { display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .section { background: #252525; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #444; border-radius: 5px; font-size: 16px; background: #1a1a1a; color: #e0e0e0; }
        input:focus, select:focus { border-color: #3498db; outline: none; }
        .progress-bar { background: #2a2a2a; border-radius: 10px; margin: 10px 0; overflow: hidden; height: 20px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2ecc71, #3498db); border-radius: 10px; transition: width 0.5s ease; }
        .chart-container { background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; border: 1px solid #333; overflow: auto; }
        .time-input { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        h4 { color: #3498db; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        label { color: #b0b0b0; display: block; margin-bottom: 5px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { margin-bottom: 8px; display: block; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .unit { color: #888; font-size: 12px; margin-left: 5px; }
        .sensor-value { font-weight: bold; color: #2ecc71; }
        .legend { display: flex; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; margin: 5px 15px; cursor: pointer; }
        .legend-color { width: 15px; height: 15px; border-radius: 3px; margin-right: 5px; transition: opacity 0.3s; }
        .moisture-color { background: #3498db; }
        .pwec-color { background: #2ecc71; }
        .target-line { stroke: #e74c3c; stroke-width: 1; stroke-dasharray: 5,5; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #2c3e50; color: white; border-radius: 5px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); z-index: 1000; transform: translateX(150%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #27ae60; }
        .notification.error { background: #c0392b; }
        .notification.info { background: #3498db; }
        .chart-tooltip { position: absolute; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 100; }
        .chart-tooltip.show { opacity: 1; }
        .data-point { cursor: pointer; transition: r 0.2s; }
        .data-point:hover { r: 5; }
        .chart-controls { display: flex; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>ðŸŒ± Irrigation Control System</h2>
        <div id="currentTime">--:--:--</div>
    </div>
    
    <div class="status-grid">
        <div class="status-card">Moisture: <span id="moisture" class="sensor-value">--%</span></div>
        <div class="status-card">Temperature: <span id="temperature" class="sensor-value">--Â°C</span></div>
        <div class="status-card">PWEC: <span id="poreEC" class="sensor-value">-- dS/m</span></div>
        <div class="status-card">Bulk EC: <span id="bulkEC" class="sensor-value">-- ÂµS/cm</span></div>
        <div class="status-card">Water Today: <span id="waterToday" class="sensor-value">-- L</span></div>
        <div class="status-card">Epsilon B: <span id="epsilonB" class="sensor-value">--</span></div>
        <div class="status-card" style="grid-column: 1 / -1; text-align: center;">Phase: <span id="currentPhase" class="sensor-value">--</span></div>
    </div>
    
    <div class="quick-actions">
        <button class="quick-btn btn-red" id="pumpBtn">PUMP OFF</button>
        <button class="quick-btn btn-red" id="lightsBtn">LIGHTS OFF</button>
        <button class="quick-btn btn-red" id="serviceBtn">SERVICE OFF</button>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="openTab('control')">Control</button>
        <button class="tab" onclick="openTab('chart')">Chart</button>
        <button class="tab" onclick="openTab('wifi')">WiFi</button>
        <button class="tab" onclick="openTab('settings')">Settings</button>
        <button class="tab" onclick="openTab('time')">Time</button>
    </div>
    
    <div id="control" class="tabcontent" style="display:block">
        <div class="section">
            <h4>Moisture Control</h4>
            <div class="input-group">
                <label>Current Moisture: <span id="controlMoisture" class="sensor-value">--%</span></label>
                <label>Highest Moisture: <span id="controlHighest" class="sensor-value">--%</span></label>
                <label>Target Moisture: <span id="controlTarget" class="sensor-value">--%</span></label>
            </div>
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <div style="text-align: center;" id="progressText">0%</div>
            <div class="input-group">
                <label for="setHighestValue">Set Highest Moisture Value (%)</label>
                <input type="number" id="setHighestValue" placeholder="Enter value" step="0.1">
            </div>
            <div class="grid-2">
                <button class="quick-btn btn-green" onclick="setHighestMoisture()">Set Highest</button>
                <button class="quick-btn btn-red" onclick="resetHighestMoisture()">Reset to 0</button>
            </div>
        </div>
    </div>
    
    <div id="chart" class="tabcontent">
        <div class="section">
            <h4>Soil Analytics Chart</h4>
            <div class="chart-controls">
                <div>
                    <label for="timeRange">Select Time Range</label>
                    <select id="timeRange" onchange="refreshChart()">
                        <option value="24">24 Hours</option>
                        <option value="12">12 Hours</option>
                        <option value="6">6 Hours</option>
                        <option value="2">2 Hours</option>
                        <option value="1">1 Hour</option>
                    </select>
                </div>
            </div>
            <button class="quick-btn btn-green" onclick="refreshChart()" style="width: 100%;">Refresh Chart</button>
        </div>
        <div class="chart-container" id="chartContainer">
            <div style="padding: 50px; color: #666;">Loading chart data...</div>
        </div>
        <div class="legend">
            <div class="legend-item" onclick="toggleChartLine('moisture')">
                <div class="legend-color moisture-color"></div>
                <span>Moisture (%)</span>
            </div>
            <div class="legend-item" onclick="toggleChartLine('pwec')">
                <div class="legend-color pwec-color"></div>
                <span>PWEC (dS/m)</span>
            </div>
            <div class="legend-item">
                <div style="background: #e74c3c; width: 15px; height: 2px; margin-right: 5px;"></div>
                <span>Target Moisture (85%)</span>
            </div>
        </div>
    </div>
    
    <div id="wifi" class="tabcontent">
        <div class="section">
            <h4>Current Status</h4>
            <div class="input-group">
                <label>WiFi Mode: <span id="currentWifiMode" class="sensor-value">AP</span></label>
                <label>Connection Status: <span id="currentWifiStatus" class="sensor-value">AP: Irrigation_System</span></label>
                <label>IP Address: <span id="currentIP" class="sensor-value">192.168.4.1</span></label>
            </div>
        </div>
        
        <div class="section">
            <h4>Network Setup</h4>
            <div class="input-group">
                <label for="wifi_ssid">WiFi Name (SSID)</label>
                <input type="text" id="wifi_ssid" placeholder="Enter WiFi name">
            </div>
            <div class="input-group">
                <label for="wifi_password">WiFi Password</label>
                <input type="password" id="wifi_password" placeholder="Enter password">
            </div>
            <button class="quick-btn btn-green" onclick="scanNetworks()" style="width: 100%; margin-bottom: 10px;">Scan Networks</button>
            <div id="scanResults" style="border: 1px solid #444; padding: 10px; border-radius: 5px; background: #1a1a1a;">
                <div>No networks scanned yet</div>
            </div>
            <div class="grid-2" style="margin-top: 10px;">
                <button class="quick-btn btn-green" onclick="saveWiFiConfig()">Save & Connect</button>
                <button class="quick-btn btn-gray" onclick="switchToAPMode()">AP Mode</button>
            </div>
        </div>
    </div>

    <div id="settings" class="tabcontent">
        <div class="section">
            <h4>Basic Settings</h4>
            <div class="input-group">
                <label for="moisture_target">Moisture Target <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="moisture_target" value="85.0">
            </div>
            <div class="input-group">
                <label for="max_dryback">Max Dryback <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="max_dryback" value="45.0">
            </div>
            <div class="input-group">
                <label for="time_between_shots">Time Between Shots <span class="unit">(minutes)</span></label>
                <input type="number" step="0.1" id="time_between_shots" value="15.0">
            </div>
            <div class="input-group">
                <label for="pump_flow_rate">Pump Flow Rate <span class="unit">(L/hour)</span></label>
                <input type="number" step="0.1" id="pump_flow_rate" value="10.0">
            </div>
        </div>

        <div class="section">
            <h4>Shot Settings</h4>
            <div class="input-group">
                <label for="p1_shot">P1 Shot Duration <span class="unit">(seconds)</span></label>
                <input type="number" step="0.1" id="p1_shot" value="150.0">
            </div>
            <div class="input-group">
                <label for="p1_dryback">P1 Dryback Threshold <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="p1_dryback" value="0.0">
            </div>
            <div class="input-group">
                <label for="p2_shot">P2 Shot Duration <span class="unit">(seconds)</span></label>
                <input type="number" step="0.1" id="p2_shot" value="85.0">
            </div>
            <div class="input-group">
                <label for="p2_dryback">P2 Dryback Threshold <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="p2_dryback" value="6.0">
            </div>
        </div>

        <div class="section">
            <h4>Delay Settings</h4>
            <div class="input-group">
                <label for="delay_before">Delay Before Lights Off <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="delay_before" value="1.0">
            </div>
            <div class="input-group">
                <label for="delay_after">Delay After Lights On <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="delay_after" value="1.0">
            </div>
        </div>

        <div class="section">
            <h4>Advanced Settings</h4>
            <div class="input-group">
                <label for="epsilon_offset">Epsilon Offset <span class="unit">(dimensionless)</span></label>
                <input type="number" step="0.01" id="epsilon_offset" value="4.1">
            </div>
            <div class="input-group">
                <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="service_mode" style="margin-right: 10px;">
                    Service Mode
                </label>
            </div>
        </div>

        <button class="quick-btn btn-green" onclick="saveAllSettings()" style="width: 100%;">Save All Settings</button>
    </div>

    <div id="time" class="tabcontent">
        <div class="section">
            <h4>Current Time</h4>
            <div id="currentTimeDisplay" style="text-align: center; font-size: 24px; font-weight: bold; color: #2ecc71;">--:--:--</div>
        </div>

        <div class="section">
            <h4>Set Manual Time</h4>
            <div class="input-group">
                <label>Set Time Manually</label>
                <div class="time-input">
                    <div>
                        <label for="setHour">Hour</label>
                        <input type="number" id="setHour" min="0" max="23" value="12" placeholder="Hour">
                    </div>
                    <div>
                        <label for="setMinute">Minute</label>
                        <input type="number" id="setMinute" min="0" max="59" value="0" placeholder="Minute">
                    </div>
                    <div>
                        <label for="setSecond">Second</label>
                        <input type="number" id="setSecond" min="0" max="59" value="0" placeholder="Second">
                    </div>
                </div>
            </div>
            <button class="quick-btn btn-green" onclick="setTime()" style="width: 100%;">Set Time</button>
        </div>

        <div class="section">
            <h4>Light Schedule</h4>
            <div class="input-group">
                <label>Lights On Time</label>
                <div class="grid-2">
                    <div>
                        <label for="lights_hour">Hour</label>
                        <input type="number" id="lights_hour" min="0" max="23" value="9" placeholder="Hour">
                    </div>
                    <div>
                        <label for="lights_minute">Minute</label>
                        <input type="number" id="lights_minute" min="0" max="59" value="0" placeholder="Minute">
                    </div>
                </div>
            </div>
            <div class="input-group">
                <label for="dark_hours">Dark Hours Duration <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="dark_hours" value="12.0" placeholder="Dark Hours">
            </div>
            <div class="input-group">
                <label>Calculated Lights Off Time: <span id="calculatedLightsOff" class="sensor-value">21:00</span></label>
            </div>
            <button class="quick-btn btn-green" onclick="saveTimeSettings()" style="width: 100%;">Save Light Schedule</button>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    <div id="chartTooltip" class="chart-tooltip"></div>

    <script>
        // Simulation State - matches your updated Arduino structure
        let simulationState = {
            moisture: 75.0,
            temperature: 22.5,
            bulkEC: 1200,
            poreEC: 1.2,
            epsilonB: 12.5,
            highestMoisture: 85.0,
            pumpOn: false,
            lightsOn: false,
            serviceMode: false,
            maintenance: false,
            dailyWaterApplied: 2.5,
            currentSessionWater: 0,
            wateringActive: false,
            moistureTarget: 85.0,
            epsilonOffset: 4.1,
            
            // Time simulation - manual time control
            manualBase: Date.now() - (12 * 3600000), // Start at 12:00:00
            daysBase: Date.now(),
            virtualDay: 0,
            
            // Light schedule
            lightsOnTime: "09:00:00",
            darkHours: 12.0,
            cachedTimes: {
                lights_on_hour: 9,
                lights_on_minute: 0,
                lights_off_hour: 21,
                lights_off_minute: 0,
                parsed: true
            },
            
            // Simplified delay settings (no vegetative/generative)
            delay_before: 1.0,
            delay_after: 1.0,
            
            historyData: [],
            simulationStartTime: Date.now()
        };

        // Chart visibility controls
        let showMoistureLine = true;
        let showPwecLine = true;

        // Constants from your Arduino code
        const ONE_SECOND = 1000;
        const ONE_MINUTE = 60000;
        const ONE_HOUR = 3600000;
        const ONE_DAY = 86400000;

        // Calculate light off time EXACTLY like your Arduino code
        function calculateLightOffTime() {
            const lights_hour = parseInt(document.getElementById('lights_hour').value) || 0;
            const lights_minute = parseInt(document.getElementById('lights_minute').value) || 0;
            const dark_hours = parseFloat(document.getElementById('dark_hours').value) || 12.0;
            
            // EXACT calculation from your Arduino code - using Math.floor for (int) casting
            const light_hours = 24.0 - dark_hours;
            const lights_off_total_minutes = (lights_hour * 60 + lights_minute) + Math.floor(light_hours * 60);
            const lights_off_hour = Math.floor(lights_off_total_minutes / 60) % 24;
            const lights_off_minute = lights_off_total_minutes % 60;
            
            // Update display
            document.getElementById('calculatedLightsOff').textContent = 
                `${lights_off_hour.toString().padStart(2, '0')}:${lights_off_minute.toString().padStart(2, '0')}`;
            
            // Update simulation state
            simulationState.cachedTimes.lights_on_hour = lights_hour;
            simulationState.cachedTimes.lights_on_minute = lights_minute;
            simulationState.cachedTimes.lights_off_hour = lights_off_hour;
            simulationState.cachedTimes.lights_off_minute = lights_off_minute;
            simulationState.darkHours = dark_hours;
            
            console.log(`Lights ON: ${lights_hour}:${lights_minute}, Lights OFF: ${lights_off_hour}:${lights_off_minute}, Dark: ${dark_hours}h, Light: ${light_hours}h`);
        }

        // Safe time difference calculation from your code
        function safeTimeDifference(current, previous) {
            return (current >= previous) ? (current - previous) : (Number.MAX_SAFE_INTEGER - previous + current + 1);
        }

        // Update time exactly like your Arduino code
        function updateTime() {
            const current_millis = Date.now();
            const total_millis = safeTimeDifference(current_millis, simulationState.manualBase);
            const total_seconds = Math.floor(total_millis / ONE_SECOND);
            
            const hours = Math.floor(total_seconds / 3600) % 24;
            const minutes = Math.floor((total_seconds % 3600) / 60);
            const seconds = total_seconds % 60;
            
            simulationState.virtualDay = Math.floor(safeTimeDifference(current_millis, simulationState.daysBase) / ONE_DAY);
            
            const time_str = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('currentTime').textContent = time_str;
            document.getElementById('currentTimeDisplay').textContent = time_str;
        }

        // Set manual time exactly like your Arduino code
        function setManualTime(h, m, s) {
            simulationState.manualBase = Date.now() - (h * ONE_HOUR + m * ONE_MINUTE + s * ONE_SECOND);
        }

        // Check if current time is within light period
        function isLightTime() {
            const current_millis = Date.now();
            const total_millis = safeTimeDifference(current_millis, simulationState.manualBase);
            const total_seconds = Math.floor(total_millis / ONE_SECOND);
            
            const current_hour = Math.floor(total_seconds / 3600) % 24;
            const current_minute = Math.floor((total_seconds % 3600) / 60);
            const current_second = total_seconds % 60;
            
            const current_secs = current_hour * 3600 + current_minute * 60 + current_second;
            const start_secs = simulationState.cachedTimes.lights_on_hour * 3600 + simulationState.cachedTimes.lights_on_minute * 60;
            const end_secs = simulationState.cachedTimes.lights_off_hour * 3600 + simulationState.cachedTimes.lights_off_minute * 60;
            
            if (start_secs < end_secs) {
                return (current_secs >= start_secs && current_secs < end_secs);
            } else {
                return (current_secs >= start_secs || current_secs < end_secs);
            }
        }

        function openTab(tabName) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.currentTarget.classList.add('active');
            if (tabName === 'chart') refreshChart();
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function toggleChartLine(lineType) {
            if (lineType === 'moisture') {
                showMoistureLine = !showMoistureLine;
                document.querySelector('.moisture-color').style.opacity = showMoistureLine ? '1' : '0.3';
            } else if (lineType === 'pwec') {
                showPwecLine = !showPwecLine;
                document.querySelector('.pwec-color').style.opacity = showPwecLine ? '1' : '0.3';
            }
            refreshChart();
        }

        function showDataPointTooltip(event) {
            const point = event.target;
            const moisture = point.getAttribute('data-moisture');
            const pwec = point.getAttribute('data-pwec');
            const timestamp = point.getAttribute('data-time');
            
            const tooltip = document.getElementById('chartTooltip');
            tooltip.innerHTML = `
                <div>Time: ${timestamp}</div>
                <div>Moisture: ${moisture}%</div>
                <div>PWEC: ${pwec} dS/m</div>
            `;
            tooltip.classList.add('show');
            
            const rect = point.getBoundingClientRect();
            tooltip.style.left = (rect.left + window.scrollX + 10) + 'px';
            tooltip.style.top = (rect.top + window.scrollY - 40) + 'px';
        }

        function hideDataPointTooltip() {
            const tooltip = document.getElementById('chartTooltip');
            tooltip.classList.remove('show');
        }

        // ORIGINAL CHART SIMULATION - like your original code
        function generateTimeLabels(timeRange) {
            const now = new Date();
            const labels = [];
            
            for (let i = 6; i >= 0; i--) {
                const time = new Date(now.getTime() - (i * timeRange * 3600000 / 6));
                const hours = time.getHours().toString().padStart(2, '0');
                const minutes = time.getMinutes().toString().padStart(2, '0');
                labels.push(`${hours}:${minutes}`);
            }
            
            return labels;
        }

        function generateChart(data) {
            const timeRange = parseInt(document.getElementById('timeRange').value);
            const width = 600;
            const height = 350;
            const margin = { top: 20, right: 80, bottom: 60, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom - 40;

            // Filter data based on selected time range - ORIGINAL LOGIC
            const filteredData = data.history.filter(point => point.hours_ago <= timeRange);
            
            // Create SVG element
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", width);
            svg.setAttribute("height", height);
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.style.background = "#1a1a1a";
            svg.style.borderRadius = "5px";
            
            const chart = document.createElementNS("http://www.w3.org/2000/svg", "g");
            chart.setAttribute("transform", `translate(${margin.left},${margin.top})`);
            
            // Grid
            const grid = document.createElementNS("http://www.w3.org/2000/svg", "g");
            grid.setAttribute("stroke", "#333");
            grid.setAttribute("stroke-width", "1");
            
            // Horizontal grid lines
            for (let i = 0; i <= 4; i++) {
                const y = i * (chartHeight / 4);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", "0");
                line.setAttribute("y1", y);
                line.setAttribute("x2", chartWidth);
                line.setAttribute("y2", y);
                grid.appendChild(line);
            }
            
            // Vertical grid lines
            for (let i = 0; i <= 6; i++) {
                const x = i * (chartWidth / 6);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x);
                line.setAttribute("y1", "0");
                line.setAttribute("x2", x);
                line.setAttribute("y2", chartHeight);
                grid.appendChild(line);
            }
            
            chart.appendChild(grid);
            
            // Left Y-axis (Moisture)
            const yAxisLeft = document.createElementNS("http://www.w3.org/2000/svg", "g");
            yAxisLeft.setAttribute("fill", "#3498db");
            yAxisLeft.setAttribute("font-size", "10");
            yAxisLeft.setAttribute("text-anchor", "end");
            
            for (let i = 0; i <= 4; i++) {
                const value = 100 - i * 25;
                const y = i * (chartHeight / 4);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", -5);
                text.setAttribute("y", y + 3);
                text.textContent = value + "%";
                yAxisLeft.appendChild(text);
            }
            
            const yAxisLeftTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            yAxisLeftTitle.setAttribute("transform", "rotate(-90)");
            yAxisLeftTitle.setAttribute("x", -chartHeight / 2);
            yAxisLeftTitle.setAttribute("y", -35);
            yAxisLeftTitle.setAttribute("fill", "#3498db");
            yAxisLeftTitle.setAttribute("font-size", "11");
            yAxisLeftTitle.setAttribute("text-anchor", "middle");
            yAxisLeftTitle.textContent = "Moisture (%)";
            yAxisLeft.appendChild(yAxisLeftTitle);
            
            chart.appendChild(yAxisLeft);
            
            // Right Y-axis (PWEC)
            const yAxisRight = document.createElementNS("http://www.w3.org/2000/svg", "g");
            yAxisRight.setAttribute("fill", "#2ecc71");
            yAxisRight.setAttribute("font-size", "10");
            yAxisRight.setAttribute("text-anchor", "start");
            
            for (let i = 0; i <= 4; i++) {
                const value = 2.5 - i * 0.5;
                const y = i * (chartHeight / 4);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", chartWidth + 10);
                text.setAttribute("y", y + 3);
                text.textContent = value.toFixed(1);
                yAxisRight.appendChild(text);
            }
            
            const yAxisRightTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            yAxisRightTitle.setAttribute("transform", "rotate(90)");
            yAxisRightTitle.setAttribute("x", chartHeight / 2);
            yAxisRightTitle.setAttribute("y", chartWidth + 45);
            yAxisRightTitle.setAttribute("fill", "#2ecc71");
            yAxisRightTitle.setAttribute("font-size", "11");
            yAxisRightTitle.setAttribute("text-anchor", "middle");
            yAxisRightTitle.textContent = "PWEC (dS/m)";
            yAxisRight.appendChild(yAxisRightTitle);
            
            chart.appendChild(yAxisRight);
            
            // X-axis (Time) - ORIGINAL LABELING
            const xAxis = document.createElementNS("http://www.w3.org/2000/svg", "g");
            xAxis.setAttribute("transform", `translate(0,${chartHeight})`);
            xAxis.setAttribute("fill", "#e0e0e0");
            xAxis.setAttribute("font-size", "10");
            xAxis.setAttribute("text-anchor", "middle");
            
            const timeLabels = generateTimeLabels(timeRange);
            for (let i = 0; i < timeLabels.length; i++) {
                const x = i * (chartWidth / 6);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", x);
                text.setAttribute("y", 20);
                text.textContent = timeLabels[i];
                xAxis.appendChild(text);
            }
            
            const xAxisTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            xAxisTitle.setAttribute("x", chartWidth / 2);
            xAxisTitle.setAttribute("y", 40);
            xAxisTitle.setAttribute("fill", "#e0e0e0");
            xAxisTitle.setAttribute("font-size", "11");
            xAxisTitle.setAttribute("text-anchor", "middle");
            xAxisTitle.textContent = "Time";
            xAxis.appendChild(xAxisTitle);
            
            chart.appendChild(xAxis);
            
            // Target moisture line
            const targetLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
            targetLine.setAttribute("x1", "0");
            targetLine.setAttribute("y1", chartHeight * (1 - (simulationState.moistureTarget / 100)));
            targetLine.setAttribute("x2", chartWidth);
            targetLine.setAttribute("y2", chartHeight * (1 - (simulationState.moistureTarget / 100)));
            targetLine.setAttribute("stroke", "#e74c3c");
            targetLine.setAttribute("stroke-width", "1");
            targetLine.setAttribute("stroke-dasharray", "5,5");
            chart.appendChild(targetLine);
            
            // Moisture line - ORIGINAL SIMULATION
            if (showMoistureLine && filteredData.length > 1) {
                const moisturePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                let moisturePathData = "M ";
                
                filteredData.forEach((point, index) => {
                    const x = (1 - point.hours_ago / timeRange) * chartWidth;
                    const y = chartHeight * (1 - (point.moisture / 100));
                    
                    if (index === 0) {
                        moisturePathData += `${x},${y}`;
                    } else {
                        moisturePathData += ` L ${x},${y}`;
                    }
                });
                
                moisturePath.setAttribute("d", moisturePathData);
                moisturePath.setAttribute("fill", "none");
                moisturePath.setAttribute("stroke", "#3498db");
                moisturePath.setAttribute("stroke-width", "2");
                moisturePath.setAttribute("opacity", showMoistureLine ? "1" : "0.3");
                chart.appendChild(moisturePath);
                
                // Moisture data points
                filteredData.forEach((point, index) => {
                    if (index % 3 === 0) {
                        const x = (1 - point.hours_ago / timeRange) * chartWidth;
                        const y = chartHeight * (1 - (point.moisture / 100));
                        
                        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        circle.setAttribute("cx", x);
                        circle.setAttribute("cy", y);
                        circle.setAttribute("r", "3");
                        circle.setAttribute("fill", "#3498db");
                        circle.setAttribute("class", "data-point");
                        circle.setAttribute("data-moisture", point.moisture.toFixed(1));
                        circle.setAttribute("data-pwec", point.pwec.toFixed(2));
                        circle.setAttribute("data-time", point.timestamp);
                        circle.addEventListener("mouseover", showDataPointTooltip);
                        circle.addEventListener("mouseout", hideDataPointTooltip);
                        chart.appendChild(circle);
                    }
                });
            }
            
            // PWEC line - ORIGINAL SIMULATION
            if (showPwecLine && filteredData.length > 1) {
                const pwecPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                let pwecPathData = "M ";
                
                filteredData.forEach((point, index) => {
                    const x = (1 - point.hours_ago / timeRange) * chartWidth;
                    const y = chartHeight * (1 - (point.pwec / 2.5));
                    
                    if (index === 0) {
                        pwecPathData += `${x},${y}`;
                    } else {
                        pwecPathData += ` L ${x},${y}`;
                    }
                });
                
                pwecPath.setAttribute("d", pwecPathData);
                pwecPath.setAttribute("fill", "none");
                pwecPath.setAttribute("stroke", "#2ecc71");
                pwecPath.setAttribute("stroke-width", "2");
                pwecPath.setAttribute("opacity", showPwecLine ? "1" : "0.3");
                chart.appendChild(pwecPath);
                
                // PWEC data points
                filteredData.forEach((point, index) => {
                    if (index % 3 === 0) {
                        const x = (1 - point.hours_ago / timeRange) * chartWidth;
                        const y = chartHeight * (1 - (point.pwec / 2.5));
                        
                        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        circle.setAttribute("cx", x);
                        circle.setAttribute("cy", y);
                        circle.setAttribute("r", "3");
                        circle.setAttribute("fill", "#2ecc71");
                        circle.setAttribute("class", "data-point");
                        circle.setAttribute("data-moisture", point.moisture.toFixed(1));
                        circle.setAttribute("data-pwec", point.pwec.toFixed(2));
                        circle.setAttribute("data-time", point.timestamp);
                        circle.addEventListener("mouseover", showDataPointTooltip);
                        circle.addEventListener("mouseout", hideDataPointTooltip);
                        chart.appendChild(circle);
                    }
                });
            }
            
            svg.appendChild(chart);
            return svg;
        }
        
        function refreshChart() {
            const timeRange = document.getElementById('timeRange').value;
            
            // Generate simulated chart data
            const chartData = {
                history: simulationState.historyData,
                target_moisture: simulationState.moistureTarget
            };
            
            const chartContainer = document.getElementById('chartContainer');
            const chart = generateChart(chartData);
            chartContainer.innerHTML = '';
            chartContainer.appendChild(chart);
            
            showNotification('Chart updated for ' + timeRange + ' hours', 'success');
        }
        
        function togglePump() { 
            simulationState.pumpOn = !simulationState.pumpOn;
            const button = document.getElementById('pumpBtn');
            if (simulationState.pumpOn) {
                button.textContent = 'PUMP ON';
                button.classList.remove('btn-red');
                button.classList.add('btn-green');
                showNotification('Pump started', 'success');
            } else {
                button.textContent = 'PUMP OFF';
                button.classList.remove('btn-green');
                button.classList.add('btn-red');
                showNotification('Pump stopped', 'info');
            }
        }
        
        function toggleLights() { 
            simulationState.lightsOn = !simulationState.lightsOn;
            const button = document.getElementById('lightsBtn');
            if (simulationState.lightsOn) {
                button.textContent = 'LIGHTS ON';
                button.classList.remove('btn-red');
                button.classList.add('btn-green');
                showNotification('Lights turned on', 'success');
            } else {
                button.textContent = 'LIGHTS OFF';
                button.classList.remove('btn-green');
                button.classList.add('btn-red');
                showNotification('Lights turned off', 'info');
            }
        }
        
        function toggleService() { 
            simulationState.serviceMode = !simulationState.serviceMode;
            const button = document.getElementById('serviceBtn');
            if (simulationState.serviceMode) {
                button.textContent = 'SERVICE ON';
                button.classList.remove('btn-red');
                button.classList.add('btn-green');
                showNotification('Service mode activated', 'success');
            } else {
                button.textContent = 'SERVICE OFF';
                button.classList.remove('btn-green');
                button.classList.add('btn-red');
                showNotification('Service mode deactivated', 'info');
            }
        }
        
        function setHighestMoisture() {
            const value = document.getElementById('setHighestValue').value;
            if (value) {
                simulationState.highestMoisture = parseFloat(value);
                showNotification('Highest moisture set to ' + value + '%', 'success');
            }
        }
        
        function resetHighestMoisture() { 
            simulationState.highestMoisture = 0;
            showNotification('Highest moisture reset to 0%', 'info');
        }
        
        function setTime() {
            const hour = parseInt(document.getElementById('setHour').value) || 0;
            const minute = parseInt(document.getElementById('setMinute').value) || 0;
            const second = parseInt(document.getElementById('setSecond').value) || 0;
            
            setManualTime(hour, minute, second);
            showNotification(`Time set to ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:${second.toString().padStart(2, '0')}`, 'success');
        }
        
        function saveTimeSettings() {
            const lights_hour = document.getElementById('lights_hour').value;
            const lights_minute = document.getElementById('lights_minute').value;
            const dark_hours = document.getElementById('dark_hours').value;
            
            calculateLightOffTime();
            showNotification('Light schedule saved!', 'success');
        }
        
        function scanNetworks() {
            const networks = [
                { ssid: 'Home_WiFi_5G', rssi: -45 },
                { ssid: 'Home_WiFi', rssi: -55 },
                { ssid: 'Neighbor_WiFi', rssi: -75 },
                { ssid: 'Guest_Network', rssi: -82 }
            ];
            
            let html = '';
            networks.forEach(network => {
                const strength = Math.min(Math.max(2 * (network.rssi + 100), 0), 100);
                html += `<div style="padding: 10px; border-bottom: 1px solid #444; cursor: pointer;" 
                         onclick="document.getElementById('wifi_ssid').value='${network.ssid}'">
                          <strong>${network.ssid}</strong><br>
                          <small>Signal: ${strength}%</small>
                        </div>`;
            });
            document.getElementById('scanResults').innerHTML = html;
            showNotification('Found ' + networks.length + ' networks', 'info');
        }
        
        function saveWiFiConfig() {
            const ssid = document.getElementById('wifi_ssid').value;
            const password = document.getElementById('wifi_password').value;
            
            if (!ssid) {
                showNotification('Please enter a WiFi SSID', 'error');
                return;
            }
            
            showNotification(`Connecting to ${ssid}...`, 'info');
            
            setTimeout(() => {
                showNotification(`Successfully connected to ${ssid}`, 'success');
                document.getElementById('currentWifiMode').textContent = 'Client';
                document.getElementById('currentWifiStatus').textContent = `Connected: ${ssid}`;
                document.getElementById('currentIP').textContent = '192.168.1.105';
            }, 2000);
        }
        
        function switchToAPMode() {
            showNotification('Switching to AP mode...', 'info');
            setTimeout(() => {
                showNotification('AP mode activated', 'success');
                document.getElementById('currentWifiMode').textContent = 'AP';
                document.getElementById('currentWifiStatus').textContent = 'AP: Irrigation_System';
                document.getElementById('currentIP').textContent = '192.168.4.1';
            }, 1000);
        }
        
        function saveAllSettings() {
            simulationState.moistureTarget = parseFloat(document.getElementById('moisture_target').value);
            simulationState.epsilonOffset = parseFloat(document.getElementById('epsilon_offset').value);
            simulationState.serviceMode = document.getElementById('service_mode').checked;
            simulationState.delay_before = parseFloat(document.getElementById('delay_before').value);
            simulationState.delay_after = parseFloat(document.getElementById('delay_after').value);
            
            showNotification('Settings saved successfully!', 'success');
        }

        // Initialize with some historical data - ORIGINAL SIMULATION
        function initializeHistoryData() {
            const now = Date.now();
            const data = [];
            
            for (let i = 144; i >= 0; i--) {
                const timestamp = new Date(now - i * 10 * 60 * 1000);
                
                const baseMoisture = 75 + Math.sin(i * 0.1) * 10;
                const noise = (Math.random() - 0.5) * 2;
                const moisture = Math.max(60, Math.min(95, baseMoisture + noise));
                
                const pwec = 0.8 + (moisture / 100) * 1.5 + (Math.random() - 0.5) * 0.3;
                
                data.push({
                    hours_ago: i * 10 / 60,
                    timestamp: timestamp.toTimeString().substring(0, 5),
                    moisture: moisture,
                    pwec: Math.max(0.1, pwec)
                });
            }
            
            simulationState.historyData = data;
        }

        // Simulate sensor data updates - ORIGINAL BEHAVIOR
        function simulateSensorReadings() {
            // Moisture changes gradually
            let moistureChange = -0.02;
            if (simulationState.pumpOn) {
                moistureChange = 0.3;
                simulationState.currentSessionWater += 0.05;
            }
            moistureChange += (Math.random() - 0.5) * 0.05;
            
            simulationState.moisture = Math.max(60, Math.min(95, simulationState.moisture + moistureChange));
            
            // Update highest moisture
            if (simulationState.moisture > simulationState.highestMoisture) {
                simulationState.highestMoisture = simulationState.moisture;
            }
            
            // Other sensors with some variation
            simulationState.temperature = 22.5 + (Math.random() - 0.5) * 0.5;
            simulationState.bulkEC = 1200 + (Math.random() - 0.5) * 100;
            simulationState.poreEC = 1.2 + (Math.random() - 0.5) * 0.1;
            simulationState.epsilonB = 12.5 + (Math.random() - 0.5) * 0.5;
            
            // Add to history occasionally - ORIGINAL FREQUENCY
            if (Math.random() < 0.05) {
                const currentTime = Date.now();
                const hoursAgo = (currentTime - simulationState.simulationStartTime) / (1000 * 60 * 60);
                
                const timeDate = new Date(currentTime);
                simulationState.historyData.push({
                    hours_ago: hoursAgo,
                    timestamp: timeDate.toTimeString().substring(0, 5),
                    moisture: simulationState.moisture,
                    pwec: simulationState.poreEC
                });
                
                if (simulationState.historyData.length > 200) {
                    simulationState.historyData.shift();
                }
            }
        }

        function getCurrentPhase() {
            if (simulationState.serviceMode) return "Service";
            if (simulationState.maintenance) return "P2";
            return "P1";
        }

        function updateStatus() {
            // Update time first
            updateTime();
            
            // Update all displayed values
            document.getElementById('moisture').textContent = simulationState.moisture.toFixed(1) + '%';
            document.getElementById('temperature').textContent = simulationState.temperature.toFixed(1) + 'Â°C';
            document.getElementById('poreEC').textContent = simulationState.poreEC.toFixed(3) + ' dS/m';
            document.getElementById('bulkEC').textContent = Math.round(simulationState.bulkEC) + ' ÂµS/cm';
            document.getElementById('waterToday').textContent = simulationState.dailyWaterApplied.toFixed(1) + ' L';
            document.getElementById('epsilonB').textContent = simulationState.epsilonB.toFixed(1);
            document.getElementById('currentPhase').textContent = getCurrentPhase();
            
            document.getElementById('controlMoisture').textContent = simulationState.moisture.toFixed(1) + '%';
            document.getElementById('controlHighest').textContent = simulationState.highestMoisture.toFixed(1) + '%';
            document.getElementById('controlTarget').textContent = simulationState.moistureTarget.toFixed(1) + '%';
            document.getElementById('currentIrrigationPhase').textContent = getCurrentPhase();
            
            const progress = Math.min(100, Math.max(0, (simulationState.highestMoisture / simulationState.moistureTarget) * 100));
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress.toFixed(0) + '%';
            
            document.getElementById('pumpBtn').textContent = simulationState.pumpOn ? 'PUMP ON' : 'PUMP OFF';
            document.getElementById('lightsBtn').textContent = simulationState.lightsOn ? 'LIGHTS ON' : 'LIGHTS OFF';
            document.getElementById('serviceBtn').textContent = simulationState.serviceMode ? 'SERVICE ON' : 'SERVICE OFF';
            document.getElementById('pumpBtn').className = simulationState.pumpOn ? 'quick-btn btn-green' : 'quick-btn btn-red';
            document.getElementById('lightsBtn').className = simulationState.lightsOn ? 'quick-btn btn-green' : 'quick-btn btn-red';
            document.getElementById('serviceBtn').className = simulationState.serviceMode ? 'quick-btn btn-green' : 'quick-btn btn-red';
            
            // Update settings form
            document.getElementById('moisture_target').value = simulationState.moistureTarget;
            document.getElementById('service_mode').checked = simulationState.serviceMode;
            document.getElementById('delay_before').value = simulationState.delay_before;
            document.getElementById('delay_after').value = simulationState.delay_after;
        }
        
        // Add event listeners
        document.getElementById('pumpBtn').addEventListener('click', togglePump);
        document.getElementById('lightsBtn').addEventListener('click', toggleLights);
        document.getElementById('serviceBtn').addEventListener('click', toggleService);
        
        // Initialize
        initializeHistoryData();
        calculateLightOffTime(); // Calculate initial light off time
        simulationState.simulationStartTime = Date.now();
        
        document.getElementById('dark_hours').addEventListener('input', calculateLightOffTime);
        document.getElementById('lights_hour').addEventListener('input', calculateLightOffTime);
        document.getElementById('lights_minute').addEventListener('input', calculateLightOffTime);
        
        // Start simulation loop
        setInterval(() => {
            simulateSensorReadings();
            updateStatus();
        }, 2000);
        
        updateStatus();
    </script>
</body>
</html>
