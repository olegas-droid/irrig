<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irrigation Control System</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #e0e0e0; padding: 10px; line-height: 1.5; }
        .header { background: linear-gradient(135deg, #1a1a1a, #2a2a2a); color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .status-card { background: #1a1a1a; padding: 12px; border-radius: 8px; font-size: 14px; border: 1px solid #333; transition: all 0.3s ease; }
        .status-card:hover { background: #252525; transform: translateY(-2px); }
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .quick-btn { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .quick-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        .quick-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-green { background: #27ae60; color: white; }
        .btn-green:hover { background: #2ecc71; }
        .btn-red { background: #c0392b; color: white; }
        .btn-red:hover { background: #e74c3c; }
        .btn-gray { background: #34495e; color: white; }
        .btn-gray:hover { background: #4a6b8a; }
        .tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
        .tab { padding: 12px; border: 1px solid #333; background: #1a1a1a; border-radius: 8px; font-size: 14px; color: #e0e0e0; cursor: pointer; transition: all 0.3s ease; }
        .tab:hover { background: #2a2a2a; }
        .tab.active { background: #3498db; color: white; border-color: #3498db; }
        .tabcontent { display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .section { background: #252525; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #444; border-radius: 5px; font-size: 16px; background: #1a1a1a; color: #e0e0e0; }
        input:focus, select:focus { border-color: #3498db; outline: none; }
        .progress-bar { background: #2a2a2a; border-radius: 10px; margin: 10px 0; overflow: hidden; height: 20px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2ecc71, #3498db); border-radius: 10px; transition: width 0.5s ease; }
        .chart-container { background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; border: 1px solid #333; overflow: auto; }
        .time-input { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        h4 { color: #3498db; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        label { color: #b0b0b0; display: block; margin-bottom: 5px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { margin-bottom: 8px; display: block; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .unit { color: #888; font-size: 12px; margin-left: 5px; }
        .sensor-value { font-weight: bold; color: #2ecc71; }
        .legend { display: flex; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; margin: 5px 15px; cursor: pointer; }
        .legend-color { width: 15px; height: 15px; border-radius: 3px; margin-right: 5px; transition: opacity 0.3s; }
        .moisture-color { background: #3498db; }
        .pwec-color { background: #2ecc71; }
        .target-line { stroke: #e74c3c; stroke-width: 1; stroke-dasharray: 5,5; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #2c3e50; color: white; border-radius: 5px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); z-index: 1000; transform: translateX(150%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #27ae60; }
        .notification.error { background: #c0392b; }
        .notification.info { background: #3498db; }
        .chart-tooltip { position: absolute; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 100; }
        .chart-tooltip.show { opacity: 1; }
        .data-point { cursor: pointer; transition: r 0.2s; }
        .data-point:hover { r: 5; }
        .chart-controls { display: flex; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>ðŸŒ± Irrigation Control System</h2>
        <div id="currentTime">--:--:--</div>
    </div>
    
    <div class="status-grid">
        <div class="status-card">Moisture: <span id="moisture" class="sensor-value">--%</span></div>
        <div class="status-card">Temperature: <span id="temperature" class="sensor-value">--Â°C</span></div>
        <div class="status-card">PWEC: <span id="poreEC" class="sensor-value">-- dS/m</span></div>
        <div class="status-card">Bulk EC: <span id="bulkEC" class="sensor-value">-- ÂµS/cm</span></div>
        <div class="status-card">Water Today: <span id="waterToday" class="sensor-value">-- L</span></div>
        <div class="status-card">Epsilon B: <span id="epsilonB" class="sensor-value">--</span></div>
        <div class="status-card" style="grid-column: 1 / -1; text-align: center;">Phase: <span id="currentPhase" class="sensor-value">--</span></div>
    </div>
    
    <div class="quick-actions">
        <button class="quick-btn btn-red" id="pumpBtn">PUMP OFF</button>
        <button class="quick-btn btn-red" id="lightsBtn">LIGHTS OFF</button>
        <button class="quick-btn btn-red" id="serviceBtn">SERVICE OFF</button>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="openTab('control')">Control</button>
        <button class="tab" onclick="openTab('chart')">Chart</button>
        <button class="tab" onclick="openTab('wifi')">WiFi</button>
        <button class="tab" onclick="openTab('settings')">Settings</button>
        <button class="tab" onclick="openTab('time')">Time</button>
    </div>
    
    <div id="control" class="tabcontent" style="display:block">
        <div class="section">
            <h4>Moisture Control</h4>
            <div class="input-group">
                <label>Current Moisture: <span id="controlMoisture" class="sensor-value">--%</span></label>
                <label>Highest Moisture: <span id="controlHighest" class="sensor-value">--%</span></label>
                <label>Target Moisture: <span id="controlTarget" class="sensor-value">--%</span></label>
            </div>
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <div style="text-align: center;" id="progressText">0%</div>
            <div class="input-group">
                <label for="setHighestValue">Set Highest Moisture Value (%)</label>
                <input type="number" id="setHighestValue" placeholder="Enter value" step="0.1">
            </div>
            <div class="grid-2">
                <button class="quick-btn btn-green" onclick="setHighestMoisture()">Set Highest</button>
                <button class="quick-btn btn-red" onclick="resetHighestMoisture()">Reset to 0</button>
            </div>
        </div>
    </div>
    
    <div id="chart" class="tabcontent">
        <div class="section">
            <h4>Soil Analytics Chart</h4>
            <div class="chart-controls">
                <div>
                    <label for="timeRange">Select Time Range</label>
                    <select id="timeRange" onchange="refreshChart()">
                        <option value="24">24 Hours</option>
                        <option value="12">12 Hours</option>
                        <option value="6">6 Hours</option>
                        <option value="2">2 Hours</option>
                        <option value="1">1 Hour</option>
                    </select>
                </div>
            </div>
            <button class="quick-btn btn-green" onclick="refreshChart()" style="width: 100%;">Refresh Chart</button>
        </div>
        <div class="chart-container" id="chartContainer">
            <div style="padding: 50px; color: #666;">Loading chart data...</div>
        </div>
        <div class="legend">
            <div class="legend-item" onclick="toggleChartLine('moisture')">
                <div class="legend-color moisture-color"></div>
                <span>Moisture (%)</span>
            </div>
            <div class="legend-item" onclick="toggleChartLine('pwec')">
                <div class="legend-color pwec-color"></div>
                <span>PWEC (dS/m)</span>
            </div>
            <div class="legend-item">
                <div style="background: #e74c3c; width: 15px; height: 2px; margin-right: 5px;"></div>
                <span>Target Moisture (85%)</span>
            </div>
        </div>
    </div>
    
    <div id="wifi" class="tabcontent">
        <div class="section">
            <h4>Current Status</h4>
            <div class="input-group">
                <label>WiFi Mode: <span id="currentWifiMode" class="sensor-value">AP</span></label>
                <label>Connection Status: <span id="currentWifiStatus" class="sensor-value">AP: Irrigation_System</span></label>
                <label>IP Address: <span id="currentIP" class="sensor-value">192.168.4.1</span></label>
            </div>
        </div>
        
        <div class="section">
            <h4>Network Setup</h4>
            <div class="input-group">
                <label for="wifi_ssid">WiFi Name (SSID)</label>
                <input type="text" id="wifi_ssid" placeholder="Enter WiFi name">
            </div>
            <div class="input-group">
                <label for="wifi_password">WiFi Password</label>
                <input type="password" id="wifi_password" placeholder="Enter password">
            </div>
            <button class="quick-btn btn-green" onclick="scanNetworks()" style="width: 100%; margin-bottom: 10px;">Scan Networks</button>
            <div id="scanResults" style="border: 1px solid #444; padding: 10px; border-radius: 5px; background: #1a1a1a;">
                <div>No networks scanned yet</div>
            </div>
            <div class="grid-2" style="margin-top: 10px;">
                <button class="quick-btn btn-green" onclick="saveWiFiConfig()">Save & Connect</button>
                <button class="quick-btn btn-gray" onclick="switchToAPMode()">AP Mode</button>
            </div>
        </div>
    </div>

    <div id="settings" class="tabcontent">
        <div class="section">
            <h4>Basic Settings</h4>
            <div class="input-group">
                <label for="moisture_target">Moisture Target <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="moisture_target" value="85.0">
            </div>
            <div class="input-group">
                <label for="max_dryback">Max Dryback <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="max_dryback" value="45.0">
            </div>
            <div class="input-group">
                <label for="time_between_shots">Time Between Shots <span class="unit">(minutes)</span></label>
                <input type="number" step="0.1" id="time_between_shots" value="15.0">
            </div>
            <div class="input-group">
                <label for="pump_flow_rate">Pump Flow Rate <span class="unit">(L/hour)</span></label>
                <input type="number" step="0.1" id="pump_flow_rate" value="10.0">
            </div>
        </div>

        <div class="section">
            <h4>Shot Settings</h4>
            <div class="input-group">
                <label for="p1_shot">P1 Shot Duration <span class="unit">(seconds)</span></label>
                <input type="number" step="0.1" id="p1_shot" value="150.0">
            </div>
            <div class="input-group">
                <label for="p1_dryback">P1 Dryback Threshold <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="p1_dryback" value="0.0">
            </div>
            <div class="input-group">
                <label for="p2_shot">P2 Shot Duration <span class="unit">(seconds)</span></label>
                <input type="number" step="0.1" id="p2_shot" value="85.0">
            </div>
            <div class="input-group">
                <label for="p2_dryback">P2 Dryback Threshold <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="p2_dryback" value="6.0">
            </div>
        </div>

        <div class="section">
            <h4>Delay Settings</h4>
            <div class="input-group">
                <label for="delay_before">Delay Before Lights Off <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="delay_before" value="1.0">
            </div>
            <div class="input-group">
                <label for="delay_after">Delay After Lights On <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="delay_after" value="1.0">
            </div>
        </div>

        <div class="section">
            <h4>Advanced Settings</h4>
            <div class="input-group">
                <label for="epsilon_offset">Epsilon Offset <span class="unit">(dimensionless)</span></label>
                <input type="number" step="0.01" id="epsilon_offset" value="4.1">
            </div>
        </div>

        <button class="quick-btn btn-green" onclick="saveAllSettings()" style="width: 100%;">Save All Settings</button>
    </div>

    <div id="time" class="tabcontent">
        <div class="section">
            <h4>Current Time</h4>
            <div id="currentTimeDisplay" style="text-align: center; font-size: 24px; font-weight: bold; color: #2ecc71;">--:--:--</div>
        </div>

        <div class="section">
            <h4>Set Manual Time</h4>
            <div class="input-group">
                <label>Set Time Manually</label>
                <div class="time-input">
                    <div>
                        <label for="setHour">Hour</label>
                        <input type="number" id="setHour" min="0" max="23" value="12" placeholder="Hour">
                    </div>
                    <div>
                        <label for="setMinute">Minute</label>
                        <input type="number" id="setMinute" min="0" max="59" value="0" placeholder="Minute">
                    </div>
                    <div>
                        <label for="setSecond">Second</label>
                        <input type="number" id="setSecond" min="0" max="59" value="0" placeholder="Second">
                    </div>
                </div>
            </div>
            <button class="quick-btn btn-green" onclick="setTime()" style="width: 100%;">Set Time</button>
        </div>

        <div class="section">
            <h4>Time Synchronization</h4>
            <div class="input-group">
                <label for="timezone">Timezone</label>
                <select id="timezone">
                    <option value="-720">UTC-12:00 - International Date Line West</option>
                    <option value="-660">UTC-11:00 - Samoa</option>
                    <option value="-600">UTC-10:00 - Hawaii</option>
                    <option value="-540">UTC-09:00 - Alaska</option>
                    <option value="-480">UTC-08:00 - Pacific Time (US/Canada)</option>
                    <option value="-420">UTC-07:00 - Mountain Time (US/Canada)</option>
                    <option value="-360">UTC-06:00 - Central Time (US/Canada)</option>
                    <option value="-300">UTC-05:00 - Eastern Time (US/Canada)</option>
                    <option value="-240">UTC-04:00 - Atlantic Time (Canada)</option>
                    <option value="-180">UTC-03:00 - Buenos Aires</option>
                    <option value="0" selected>UTC+00:00 - London, Dublin</option>
                    <option value="60">UTC+01:00 - Paris, Berlin</option>
                    <option value="120">UTC+02:00 - Cairo, Helsinki</option>
                    <option value="180">UTC+03:00 - Moscow, Istanbul</option>
                    <option value="240">UTC+04:00 - Dubai</option>
                    <option value="300">UTC+05:00 - Karachi</option>
                    <option value="330">UTC+05:30 - Mumbai, Delhi</option>
                    <option value="360">UTC+06:00 - Dhaka</option>
                    <option value="420">UTC+07:00 - Bangkok</option>
                    <option value="480">UTC+08:00 - Beijing, Singapore</option>
                    <option value="540">UTC+09:00 - Tokyo, Seoul</option>
                    <option value="600">UTC+10:00 - Sydney</option>
                    <option value="660">UTC+11:00 - Solomon Islands</option>
                    <option value="720">UTC+12:00 - Auckland</option>
                </select>
            </div>
            <button class="quick-btn btn-green" id="syncBtn" onclick="syncTime()" style="width: 100%;">ðŸ”„ Sync with NTP</button>
        </div>

        <div class="section">
            <h4>Light Schedule</h4>
            <div class="input-group">
                <label>Lights On Time</label>
                <div class="grid-2">
                    <div>
                        <label for="lights_hour">Hour</label>
                        <input type="number" id="lights_hour" min="0" max="23" value="9" placeholder="Hour">
                    </div>
                    <div>
                        <label for="lights_minute">Minute</label>
                        <input type="number" id="lights_minute" min="0" max="59" value="0" placeholder="Minute">
                    </div>
                </div>
            </div>
            <div class="input-group">
                <label for="dark_hours">Dark Hours Duration <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="dark_hours" value="12.0" placeholder="Dark Hours">
            </div>
            <div class="input-group">
                <label>Calculated Lights Off Time: <span class="sensor-value">21:00</span></label>
            </div>
            <button class="quick-btn btn-green" onclick="saveTimeSettings()" style="width: 100%;">Save Light Schedule</button>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    <div id="chartTooltip" class="chart-tooltip"></div>

    <script>
        // Exact replica of Arduino data structures
        const Config = {
            moisture_target: 85.0,
            p1_dryback: 0.0,
            p2_dryback: 6.0,
            max_dryback: 45.0,
            p1_shot: 150.0,
            p2_shot: 85.0,
            time_between_shots: 15.0,
            dark_hours: 12.0,
            delay_before: 1.0,
            delay_after: 1.0,
            epsilon_offset: 4.1,
            maintenance: false,
            service_mode: false,
            lights_on_time: "09:00:00",
            manual_hour: 12,
            manual_minute: 0,
            manual_second: 0,
            wifi_ssid: "",
            wifi_password: "",
            wifi_client_mode: false,
            wifi_timeout: 30,
            pump_flow_rate: 10.0,
            utc_offset: 0
        };

        const State = {
            soil_moisture: 75.0,
            soil_temp: 22.5,
            soil_cond: 450,
            pore_ec: 1.2,
            highest_moisture: 75.0,
            epsilon_b: 15.3,
            pump_on: false,
            lights_on: false,
            last_irrigation: null,
            manual_base: null,
            days_base: null,
            current_time: "--:--:--",
            wifi_status: "AP: Irrigation_System",
            virtual_day: 0,
            daily_water_applied: 0,
            current_session_water: 0,
            current_session_start: null,
            watering: {
                active: false,
                start_time: null,
                duration_seconds: 0
            },
            cached_times: {
                lights_on_hour: 9,
                lights_on_minute: 0,
                lights_off_hour: 21,
                lights_off_minute: 0,
                parsed: true
            }
        };

        // History data matching Arduino structure
        const HistoryData = {
            HISTORY_SIZE: 144,
            moisture_values: new Array(144).fill(0),
            pwec_values: new Array(144).fill(0),
            timestamps: new Array(144).fill(0),
            current_index: 0,
            last_record_time: 0
        };

        // Constants
        const ONE_SECOND = 1000;
        const ONE_MINUTE = 60000;
        const ONE_HOUR = 3600000;
        const ONE_DAY = 86400000;
        const HISTORY_INTERVAL = 10 * ONE_MINUTE;

        // Simulation state
        let manualBaseTime = Date.now() - (12 * ONE_HOUR);
        let chartDataCache = null;
        let showMoistureLine = true;
        let showPwecLine = true;
        let lastResetDay = -1;

        // Initialize system
        function initializeSystem() {
            generateInitialHistory();
            parseAndCacheTimes();
            
            setInterval(updateSensors, 2000);
            setInterval(updateIrrigationLogic, 5000);
            setInterval(updateLights, 5000);
            setInterval(updateTime, 1000);
            setInterval(updateHistory, HISTORY_INTERVAL);
            setInterval(updateWatering, 1000);
            setInterval(updateSyncButtonState, 5000);
            
            updateUI();
            refreshChart();
        }

        function generateInitialHistory() {
            const now = Date.now();
            // Generate data for the last 24 hours with 10-minute intervals
            for (let i = 0; i < HistoryData.HISTORY_SIZE; i++) {
                const timestamp = now - (24 * ONE_HOUR) + (i * 10 * ONE_MINUTE);
                const recordTime = new Date(timestamp);
                const hour = recordTime.getHours();
                
                // Realistic moisture pattern with irrigation events during light hours
                let moisture = 70 + Math.random() * 10;
                if (hour >= 10 && hour <= 18 && i % 8 === 0) {
                    moisture = 85 + Math.random() * 5; // Irrigation spike
                }
                
                // PWEC correlates with moisture
                const pwec = (moisture / 100) * 1.5 + (Math.random() - 0.5) * 0.2;
                
                HistoryData.moisture_values[i] = moisture;
                HistoryData.pwec_values[i] = pwec;
                HistoryData.timestamps[i] = timestamp;
            }
            HistoryData.current_index = HistoryData.HISTORY_SIZE - 1;
            HistoryData.last_record_time = now;
        }

        function updateSensors() {
            // When pump is on, moisture should increase
            if (State.pump_on && State.watering.active) {
                // Increase moisture when watering is active
                State.soil_moisture = Math.min(100, State.soil_moisture + 0.2);
            } else {
                // Natural moisture decay when pump is off
                State.soil_moisture = Math.max(15, State.soil_moisture - (0.05 + Math.random() * 0.05));
            }
            
            const currentHour = parseInt(State.current_time.split(':')[0]);
            const targetTemp = 18 + 8 * Math.sin((currentHour - 6) * Math.PI / 12);
            State.soil_temp += (targetTemp - State.soil_temp) * 0.1;
            
            State.soil_cond = 400 + Math.random() * 100;
            
            if (State.soil_moisture > State.highest_moisture) {
                State.highest_moisture = State.soil_moisture;
            }
            
            calculatePoreWaterEC();
        }

        function calculatePoreWaterEC() {
            const VWC = State.soil_moisture * 0.01;
            const RAW = -126345 * Math.pow(VWC, 6) + 
                       390319 * Math.pow(VWC, 5) - 
                       446872 * Math.pow(VWC, 4) + 
                       227018 * Math.pow(VWC, 3) - 
                       47060 * Math.pow(VWC, 2) + 
                       4544.9 * VWC + 1739;
            
            const calibrated_cond = (1.93 * State.soil_cond - 270.8) * 0.001;
            const epsilon_b_calc = 2.887e-9 * Math.pow(RAW, 3) - 
                                 2.080e-5 * Math.pow(RAW, 2) + 
                                 5.276e-2 * RAW - 43.39;
            
            State.epsilon_b = Math.pow(epsilon_b_calc, 2);
            
            const denominator = State.epsilon_b - Config.epsilon_offset;
            const epsilon_p = 80.3 - 0.37 * (State.soil_temp - 20.0);
            
            State.pore_ec = (epsilon_p * calibrated_cond) / Math.max(denominator, 0.1);
            State.pore_ec = Math.max(0, Math.min(30.0, State.pore_ec));
        }

        // FIXED: Emergency watering and P2 switching logic
        function updateIrrigationLogic() {
            if (Config.service_mode || State.watering.active) return;
            
            const now = Date.now();
            const min_interval = Config.time_between_shots * ONE_MINUTE;
            
            if (State.last_irrigation && (now - State.last_irrigation) < min_interval) {
                return;
            }
            
            const moisture_diff = Config.moisture_target - State.soil_moisture;
            
            // FIXED: Emergency watering condition
            if (moisture_diff > Config.max_dryback) {
                console.log("EMERGENCY Watering - Max dryback exceeded");
                startWatering(Config.p2_shot);
                return;
            }
            
            const in_window = isIrrigationWindow();
            
            if (in_window) {
                if (!Config.maintenance) {
                    // P1 Watering
                    if (moisture_diff > Config.p1_dryback) {
                        console.log("P1 Watering - Normal phase");
                        startWatering(Config.p1_shot);
                    }
                    // FIXED: Switch to P2 when highest moisture reaches target
                    else if (State.highest_moisture >= Config.moisture_target) {
                        Config.maintenance = true;
                        console.log("Switched to Maintenance (P2) phase");
                    }
                } else {
                    // P2 Watering
                    if (moisture_diff > Config.p2_dryback) {
                        console.log("P2 Watering - Maintenance phase");
                        startWatering(Config.p2_shot);
                    }
                }
            } else {
                // FIXED: Reset to P1 when outside irrigation window
                if (Config.maintenance) {
                    Config.maintenance = false;
                    console.log("Reset to P1 Phase - Outside irrigation window");
                }
            }
        }

        function startWatering(seconds) {
            if (State.watering.active) return;
            
            State.watering.active = true;
            State.watering.start_time = Date.now();
            State.watering.duration_seconds = seconds;
            State.current_session_start = Date.now();
            State.current_session_water = 0;
            State.pump_on = true;
            State.last_irrigation = Date.now();
            
            console.log(`Watering started: ${seconds} seconds`);
        }

        function stopWatering() {
            if (!State.watering.active) return;
            
            const session_duration = (Date.now() - State.current_session_start) / 1000;
            const session_water = (session_duration / 3600) * Config.pump_flow_rate;
            
            State.daily_water_applied += session_water;
            State.current_session_water = 0;
            State.watering.active = false;
            State.pump_on = false;
            
            console.log(`Watering completed. Water used: ${session_water.toFixed(1)} L`);
        }

        function updateWatering() {
            if (!State.watering.active) return;
            
            const current_millis = Date.now();
            const elapsed = current_millis - State.watering.start_time;
            
            if (elapsed >= (State.watering.duration_seconds * ONE_SECOND)) {
                stopWatering();
            } else {
                const session_duration = (current_millis - State.current_session_start) / 1000;
                State.current_session_water = (session_duration / 3600) * Config.pump_flow_rate;
            }
        }

        function updateLights() {
            if (Config.service_mode) return;
            
            const should_be_on = isLightTime();
            if (should_be_on !== State.lights_on) {
                State.lights_on = should_be_on;
                console.log("Lights " + (should_be_on ? "ON" : "OFF"));
            }
        }

        function updateTime() {
            const now = Date.now();
            const total_millis = now - manualBaseTime;
            const total_seconds = Math.floor(total_millis / 1000);
            
            const hours = Math.floor((total_seconds / 3600) % 24);
            const minutes = Math.floor((total_seconds / 60) % 60);
            const seconds = total_seconds % 60;
            
            State.current_time = 
                hours.toString().padStart(2, '0') + ':' +
                minutes.toString().padStart(2, '0') + ':' +
                seconds.toString().padStart(2, '0');
            
            State.virtual_day = Math.floor((now - manualBaseTime) / ONE_DAY);
            
            // FIXED: Daily reset logic matching Arduino code
            if (hours === State.cached_times.lights_on_hour && 
                minutes === State.cached_times.lights_on_minute && 
                State.virtual_day !== lastResetDay) {
                State.highest_moisture = 0;
                State.daily_water_applied = 0;
                lastResetDay = State.virtual_day;
                console.log("Daily reset - moisture & water cleared");
            }
            
            updateUI();
        }

        function updateHistory() {
            const current_time = Date.now();
            
            if (current_time - HistoryData.last_record_time >= HISTORY_INTERVAL) {
                HistoryData.moisture_values[HistoryData.current_index] = State.soil_moisture;
                HistoryData.pwec_values[HistoryData.current_index] = State.pore_ec;
                HistoryData.timestamps[HistoryData.current_index] = current_time;
                
                HistoryData.current_index = (HistoryData.current_index + 1) % HistoryData.HISTORY_SIZE;
                HistoryData.last_record_time = current_time;
                
                chartDataCache = null;
                
                console.log(`Recorded - Moisture: ${State.soil_moisture.toFixed(1)}%, PWEC: ${State.pore_ec.toFixed(3)}`);
            }
        }

        function isLightTime() {
            return isTimeInWindow(
                State.cached_times.lights_on_hour,
                State.cached_times.lights_on_minute,
                State.cached_times.lights_off_hour,
                State.cached_times.lights_off_minute
            );
        }

        function isIrrigationWindow() {
            if (!isLightTime()) return false;
            
            const start_h = State.cached_times.lights_on_hour + Config.delay_after;
            const end_h = State.cached_times.lights_off_hour - Config.delay_before;
            
            return isTimeInWindow(
                start_h,
                State.cached_times.lights_on_minute,
                end_h,
                State.cached_times.lights_on_minute
            );
        }

        function isTimeInWindow(start_hour, start_min, end_hour, end_min) {
            const current_time = State.current_time;
            const current_hours = parseInt(current_time.split(':')[0]);
            const current_minutes = parseInt(current_time.split(':')[1]);
            const current_seconds = current_hours * 3600 + current_minutes * 60;
            const start_seconds = start_hour * 3600 + start_min * 60;
            const end_seconds = end_hour * 3600 + end_min * 60;
            
            if (start_seconds < end_seconds) {
                return current_seconds >= start_seconds && current_seconds < end_seconds;
            } else {
                return current_seconds >= start_seconds || current_seconds < end_seconds;
            }
        }

        function getCurrentPhase() {
            if (Config.service_mode) {
                return "Service";
            } else if (!isIrrigationWindow()) {
                return "P3";
            } else if (Config.maintenance) {
                return "P2";
            } else {
                return "P1";
            }
        }

        function getTodayAppliedWater() {
            if (!State.watering.active) {
                return State.daily_water_applied;
            }
            return State.daily_water_applied + State.current_session_water;
        }

        function updateUI() {
            document.getElementById('currentTime').textContent = State.current_time;
            document.getElementById('moisture').textContent = State.soil_moisture.toFixed(1) + '%';
            document.getElementById('temperature').textContent = State.soil_temp.toFixed(1) + 'Â°C';
            document.getElementById('poreEC').textContent = State.pore_ec.toFixed(3) + ' dS/m';
            document.getElementById('bulkEC').textContent = State.soil_cond.toFixed(0) + ' ÂµS/cm';
            document.getElementById('waterToday').textContent = getTodayAppliedWater().toFixed(1) + ' L';
            document.getElementById('epsilonB').textContent = State.epsilon_b.toFixed(1);
            
            const phase = getCurrentPhase();
            document.getElementById('currentPhase').textContent = phase;
            
            document.getElementById('currentTimeDisplay').textContent = State.current_time;
            document.getElementById('controlMoisture').textContent = State.soil_moisture.toFixed(1) + '%';
            document.getElementById('controlHighest').textContent = State.highest_moisture.toFixed(1) + '%';
            document.getElementById('controlTarget').textContent = Config.moisture_target.toFixed(1) + '%';
            
            const progress = Math.min(100, Math.max(0, (State.highest_moisture / Config.moisture_target) * 100));
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress.toFixed(0) + '%';
            
            document.getElementById('pumpBtn').textContent = State.pump_on ? 'PUMP ON' : 'PUMP OFF';
            document.getElementById('pumpBtn').className = State.pump_on ? 'quick-btn btn-green' : 'quick-btn btn-red';
            
            document.getElementById('lightsBtn').textContent = State.lights_on ? 'LIGHTS ON' : 'LIGHTS OFF';
            document.getElementById('lightsBtn').className = State.lights_on ? 'quick-btn btn-green' : 'quick-btn btn-red';
            
            document.getElementById('serviceBtn').textContent = Config.service_mode ? 'SERVICE ON' : 'SERVICE OFF';
            document.getElementById('serviceBtn').className = Config.service_mode ? 'quick-btn btn-green' : 'quick-btn btn-red';
        }

        function updateSyncButtonState() {
            const syncBtn = document.getElementById('syncBtn');
            if (Config.wifi_client_mode && State.wifi_status.includes('STA:')) {
                syncBtn.disabled = false;
            } else {
                syncBtn.disabled = true;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Web interface handlers
        function openTab(tabName) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.currentTarget.classList.add('active');
            if (tabName === 'chart') refreshChart();
        }

        function togglePump() {
            State.pump_on = !State.pump_on;
            if (State.pump_on) State.last_irrigation = Date.now();
            console.log("Pump " + (State.pump_on ? "ON" : "OFF"));
        }

        function toggleLights() {
            State.lights_on = !State.lights_on;
            console.log("Lights " + (State.lights_on ? "ON" : "OFF"));
        }

        function toggleService() {
            Config.service_mode = !Config.service_mode;
            console.log("Service Mode: " + (Config.service_mode ? "ON" : "OFF"));
        }

        function setHighestMoisture() {
            const value = parseFloat(document.getElementById('setHighestValue').value);
            if (!isNaN(value)) {
                State.highest_moisture = value;
                console.log("Highest moisture set to " + value + "%");
            }
        }

        function resetHighestMoisture() {
            State.highest_moisture = 0;
            console.log("Highest moisture reset to 0%");
        }

        function setTime() {
            const hour = parseInt(document.getElementById('setHour').value);
            const minute = parseInt(document.getElementById('setMinute').value);
            const second = parseInt(document.getElementById('setSecond').value);
            
            Config.manual_hour = hour;
            Config.manual_minute = minute;
            Config.manual_second = second;
            
            manualBaseTime = Date.now() - (hour * ONE_HOUR + minute * ONE_MINUTE + second * ONE_SECOND);
            console.log("Time set to " + hour + ":" + minute + ":" + second);
        }

        function syncTime() {
            const syncBtn = document.getElementById('syncBtn');
            
            if (!Config.wifi_client_mode) {
                showNotification('Sync failed - not connected to WiFi', 'error');
                return;
            }
            
            syncBtn.disabled = true;
            syncBtn.textContent = 'Syncing...';
            
            setTimeout(() => {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();
                
                Config.manual_hour = hours;
                Config.manual_minute = minutes;
                Config.manual_second = seconds;
                
                manualBaseTime = Date.now() - (hours * ONE_HOUR + minutes * ONE_MINUTE + seconds * ONE_SECOND);
                
                syncBtn.disabled = false;
                syncBtn.textContent = 'ðŸ”„ Sync with NTP';
                showNotification('Time synced successfully!', 'success');
                console.log("Time synced to NTP: " + hours + ":" + minutes + ":" + seconds);
            }, 2000);
        }

        function saveAllSettings() {
            Config.moisture_target = parseFloat(document.getElementById('moisture_target').value);
            Config.max_dryback = parseFloat(document.getElementById('max_dryback').value);
            Config.time_between_shots = parseFloat(document.getElementById('time_between_shots').value);
            Config.p1_shot = parseFloat(document.getElementById('p1_shot').value);
            Config.p1_dryback = parseFloat(document.getElementById('p1_dryback').value);
            Config.p2_shot = parseFloat(document.getElementById('p2_shot').value);
            Config.p2_dryback = parseFloat(document.getElementById('p2_dryback').value);
            Config.pump_flow_rate = parseFloat(document.getElementById('pump_flow_rate').value);
            Config.delay_before = parseFloat(document.getElementById('delay_before').value);
            Config.delay_after = parseFloat(document.getElementById('delay_after').value);
            Config.epsilon_offset = parseFloat(document.getElementById('epsilon_offset').value);
            
            calculatePoreWaterEC();
            showNotification('Settings saved successfully!', 'success');
        }

        function saveTimeSettings() {
            const hour = document.getElementById('lights_hour').value.padStart(2, '0');
            const minute = document.getElementById('lights_minute').value.padStart(2, '0');
            Config.lights_on_time = `${hour}:${minute}:00`;
            Config.dark_hours = parseFloat(document.getElementById('dark_hours').value);
            
            parseAndCacheTimes();
            showNotification('Light schedule saved!', 'success');
        }

        function parseAndCacheTimes() {
            const parts = Config.lights_on_time.split(':');
            if (parts.length >= 2) {
                State.cached_times.lights_on_hour = parseInt(parts[0]);
                State.cached_times.lights_on_minute = parseInt(parts[1]);
                
                const light_hours = 24 - Config.dark_hours;
                const lights_off_total_minutes = (State.cached_times.lights_on_hour * 60 + State.cached_times.lights_on_minute) + (light_hours * 60);
                State.cached_times.lights_off_hour = Math.floor(lights_off_total_minutes / 60) % 24;
                State.cached_times.lights_off_minute = lights_off_total_minutes % 60;
                
                State.cached_times.parsed = true;
                console.log(`Parsed times: Lights ON ${State.cached_times.lights_on_hour}:${State.cached_times.lights_on_minute}, Lights OFF ${State.cached_times.lights_off_hour}:${State.cached_times.lights_off_minute}`);
            }
        }

        function scanNetworks() {
            const networks = [
                { ssid: 'HomeWiFi', rssi: -45 },
                { ssid: 'NeighborWiFi', rssi: -65 },
                { ssid: 'GuestNetwork', rssi: -70 }
            ];
            
            let html = '';
            networks.forEach(network => {
                const strength = Math.min(Math.max(2 * (network.rssi + 100), 0), 100);
                html += `<div style="padding: 10px; border-bottom: 1px solid #444; cursor: pointer;" 
                         onclick="document.getElementById('wifi_ssid').value='${network.ssid}'">
                          <strong>${network.ssid}</strong><br>
                          <small>Signal: ${strength}%</small>
                        </div>`;
            });
            document.getElementById('scanResults').innerHTML = html;
            showNotification('Found ' + networks.length + ' networks', 'info');
        }

        function saveWiFiConfig() {
            Config.wifi_ssid = document.getElementById('wifi_ssid').value;
            Config.wifi_password = document.getElementById('wifi_password').value;
            Config.wifi_client_mode = true;
            
            setTimeout(() => {
                State.wifi_status = "STA: " + Config.wifi_ssid;
                document.getElementById('currentWifiStatus').textContent = State.wifi_status;
                document.getElementById('currentWifiMode').textContent = 'STA';
                document.getElementById('currentIP').textContent = '192.168.1.100';
                showNotification('WiFi settings saved!', 'success');
            }, 3000);
        }

        function switchToAPMode() {
            Config.wifi_client_mode = false;
            State.wifi_status = "AP: Irrigation_System";
            document.getElementById('currentWifiStatus').textContent = State.wifi_status;
            document.getElementById('currentWifiMode').textContent = 'AP';
            document.getElementById('currentIP').textContent = '192.168.4.1';
            showNotification('Switched to AP mode', 'info');
        }

        // FIXED: Chart generation matching Arduino getCachedChartData logic
        function refreshChart() {
            const timeRange = parseInt(document.getElementById('timeRange').value);
            const chartData = getChartData(timeRange);
            generateChart(chartData);
        }

        function getChartData(timeRange) {
            if (chartDataCache && chartDataCache.timeRange === timeRange) {
                return chartDataCache.data;
            }
            
            const history = [];
            
            // Replicate Arduino getHistoryDataJSON logic
            let pointsAdded = 0;
            const skip = Math.max(1, Math.floor(HistoryData.HISTORY_SIZE / 50)); // Max 50 points
            
            for (let i = 0; i < HistoryData.HISTORY_SIZE && pointsAdded < 50; i++) {
                const index = (HistoryData.current_index + i) % HistoryData.HISTORY_SIZE;
                
                if (HistoryData.timestamps[index] === 0 || HistoryData.moisture_values[index] <= 0) continue;
                if (i % skip !== 0 && pointsAdded > 10) continue; // Skip some points after first 10
                
                const record_time = HistoryData.timestamps[index];
                const total_millis = record_time - manualBaseTime;
                const total_seconds = Math.floor(total_millis / 1000);
                
                const hours = Math.floor((total_seconds / 3600) % 24);
                const minutes = Math.floor((total_seconds / 60) % 60);
                const time_str = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
                
                const time_diff = Date.now() - record_time;
                const hours_ago = time_diff / ONE_HOUR;
                
                history.push({
                    hours_ago: hours_ago,
                    timestamp: time_str,
                    moisture: HistoryData.moisture_values[index],
                    pwec: HistoryData.pwec_values[index]
                });
                
                pointsAdded++;
            }
            
            const data = {
                history: history,
                target_moisture: Config.moisture_target
            };
            
            chartDataCache = {
                timeRange: timeRange,
                data: data
            };
            
            return data;
        }

        // FIXED: Exact replica of Arduino chart generation with tooltips and data points
        function generateChart(data) {
            const timeRange = parseInt(document.getElementById('timeRange').value);
            const width = 600;
            const height = 350;
            const margin = { top: 20, right: 80, bottom: 60, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // Create SVG element
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", width);
            svg.setAttribute("height", height);
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.style.background = "#1a1a1a";
            svg.style.borderRadius = "5px";
            
            const chart = document.createElementNS("http://www.w3.org/2000/svg", "g");
            chart.setAttribute("transform", `translate(${margin.left},${margin.top})`);
            
            // Grid
            const grid = document.createElementNS("http://www.w3.org/2000/svg", "g");
            grid.setAttribute("stroke", "#333");
            grid.setAttribute("stroke-width", "1");
            
            // Horizontal grid lines
            for (let i = 0; i <= 4; i++) {
                const y = i * (chartHeight / 4);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", "0");
                line.setAttribute("y1", y);
                line.setAttribute("x2", chartWidth);
                line.setAttribute("y2", y);
                grid.appendChild(line);
            }
            
            // Vertical grid lines
            for (let i = 0; i <= 6; i++) {
                const x = i * (chartWidth / 6);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x);
                line.setAttribute("y1", "0");
                line.setAttribute("x2", x);
                line.setAttribute("y2", chartHeight);
                grid.appendChild(line);
            }
            
            chart.appendChild(grid);
            
            // Left Y-axis (Moisture)
            const yAxisLeft = document.createElementNS("http://www.w3.org/2000/svg", "g");
            yAxisLeft.setAttribute("fill", "#3498db");
            yAxisLeft.setAttribute("font-size", "10");
            yAxisLeft.setAttribute("text-anchor", "end");
            
            for (let i = 0; i <= 4; i++) {
                const value = 100 - i * 25;
                const y = i * (chartHeight / 4);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", -5);
                text.setAttribute("y", y + 3);
                text.textContent = value + "%";
                yAxisLeft.appendChild(text);
            }
            
            const yAxisLeftTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            yAxisLeftTitle.setAttribute("transform", "rotate(-90)");
            yAxisLeftTitle.setAttribute("x", -chartHeight / 2);
            yAxisLeftTitle.setAttribute("y", -35);
            yAxisLeftTitle.setAttribute("fill", "#3498db");
            yAxisLeftTitle.setAttribute("font-size", "11");
            yAxisLeftTitle.setAttribute("text-anchor", "middle");
            yAxisLeftTitle.textContent = "Moisture (%)";
            yAxisLeft.appendChild(yAxisLeftTitle);
            
            chart.appendChild(yAxisLeft);
            
            // Right Y-axis (PWEC)
            const yAxisRight = document.createElementNS("http://www.w3.org/2000/svg", "g");
            yAxisRight.setAttribute("fill", "#2ecc71");
            yAxisRight.setAttribute("font-size", "10");
            yAxisRight.setAttribute("text-anchor", "start");
            
            for (let i = 0; i <= 4; i++) {
                const value = 2.5 - i * 0.5;
                const y = i * (chartHeight / 4);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", chartWidth + 10);
                text.setAttribute("y", y + 3);
                text.textContent = value.toFixed(1);
                yAxisRight.appendChild(text);
            }
            
            const yAxisRightTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            yAxisRightTitle.setAttribute("transform", "rotate(-90)");
            yAxisRightTitle.setAttribute("x", -chartHeight / 2);
            yAxisRightTitle.setAttribute("y", chartWidth + 55);
            yAxisRightTitle.setAttribute("fill", "#2ecc71");
            yAxisRightTitle.setAttribute("font-size", "11");
            yAxisRightTitle.setAttribute("text-anchor", "middle");
            yAxisRightTitle.textContent = "PWEC (dS/m)";
            yAxisRight.appendChild(yAxisRightTitle);
            
            chart.appendChild(yAxisRight);
            
            // X-axis with time labels
            const xAxis = document.createElementNS("http://www.w3.org/2000/svg", "g");
            xAxis.setAttribute("fill", "#888");
            xAxis.setAttribute("font-size", "10");
            xAxis.setAttribute("text-anchor", "middle");
            xAxis.setAttribute("transform", `translate(0,${chartHeight + 5})`);
            
            const timeLabels = generateTimeLabelsFromData(data, timeRange);
            for (let i = 0; i <= 6; i++) {
                const x = i * (chartWidth / 6);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", x);
                text.setAttribute("y", 15);
                text.textContent = timeLabels[i];
                xAxis.appendChild(text);
            }
            
            const xAxisTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            xAxisTitle.setAttribute("x", chartWidth / 2);
            xAxisTitle.setAttribute("y", 40);
            xAxisTitle.setAttribute("fill", "#888");
            xAxisTitle.setAttribute("font-size", "11");
            xAxisTitle.setAttribute("text-anchor", "middle");
            xAxisTitle.textContent = "Time";
            xAxis.appendChild(xAxisTitle);
            
            chart.appendChild(xAxis);
            
            // Target moisture line
            const targetLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
            targetLine.setAttribute("class", "target-line");
            targetLine.setAttribute("x1", "0");
            targetLine.setAttribute("y1", chartHeight * (1 - data.target_moisture / 100));
            targetLine.setAttribute("x2", chartWidth);
            targetLine.setAttribute("y2", chartHeight * (1 - data.target_moisture / 100));
            chart.appendChild(targetLine);
            
            const targetLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            targetLabel.setAttribute("x", chartWidth - 30);
            targetLabel.setAttribute("y", chartHeight * (1 - data.target_moisture / 100) - 5);
            targetLabel.setAttribute("fill", "#e74c3c");
            targetLabel.setAttribute("font-size", "9");
            targetLabel.textContent = `Target ${data.target_moisture}%`;
            chart.appendChild(targetLabel);
            
            // Moisture line with data points and tooltips
            if (showMoistureLine && data.history && data.history.length > 0) {
                const moisturePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                let moisturePathData = "M";
                
                for (let i = 0; i < data.history.length; i++) {
                    const x = (data.history[i].hours_ago / timeRange) * chartWidth;
                    const y = chartHeight * (1 - data.history[i].moisture / 100);
                    
                    if (i === 0) {
                        moisturePathData += `${x},${y}`;
                    } else {
                        moisturePathData += ` L${x},${y}`;
                    }
                }
                
                moisturePath.setAttribute("d", moisturePathData);
                moisturePath.setAttribute("stroke", "#3498db");
                moisturePath.setAttribute("stroke-width", "2");
                moisturePath.setAttribute("fill", "none");
                moisturePath.setAttribute("opacity", showMoistureLine ? "1" : "0.3");
                chart.appendChild(moisturePath);
                
                // Moisture data points with tooltips
                for (let i = 0; i < data.history.length; i += Math.max(1, Math.floor(data.history.length / 8))) {
                    const x = (data.history[i].hours_ago / timeRange) * chartWidth;
                    const moistureY = chartHeight * (1 - data.history[i].moisture / 100);
                    
                    const moisturePoint = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    moisturePoint.setAttribute("class", "data-point");
                    moisturePoint.setAttribute("cx", x);
                    moisturePoint.setAttribute("cy", moistureY);
                    moisturePoint.setAttribute("r", "3");
                    moisturePoint.setAttribute("fill", "#3498db");
                    moisturePoint.setAttribute("data-moisture", data.history[i].moisture.toFixed(1));
                    moisturePoint.setAttribute("data-pwec", data.history[i].pwec.toFixed(3));
                    moisturePoint.setAttribute("data-time", data.history[i].timestamp);
                    
                    moisturePoint.addEventListener("mouseover", function(e) {
                        const tooltip = document.getElementById('chartTooltip');
                        tooltip.innerHTML = `
                            <div>Time: ${data.history[i].timestamp}</div>
                            <div>Moisture: ${data.history[i].moisture.toFixed(1)}%</div>
                            <div>PWEC: ${data.history[i].pwec.toFixed(3)} dS/m</div>
                        `;
                        tooltip.classList.add('show');
                        
                        const rect = moisturePoint.getBoundingClientRect();
                        tooltip.style.left = (rect.left + window.scrollX + 10) + 'px';
                        tooltip.style.top = (rect.top + window.scrollY - 40) + 'px';
                    });
                    
                    moisturePoint.addEventListener("mouseout", function() {
                        document.getElementById('chartTooltip').classList.remove('show');
                    });
                    
                    chart.appendChild(moisturePoint);
                }
            }
            
            // PWEC line with data points and tooltips
            if (showPwecLine && data.history && data.history.length > 0) {
                const pwecPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                let pwecPathData = "M";
                
                for (let i = 0; i < data.history.length; i++) {
                    const x = (data.history[i].hours_ago / timeRange) * chartWidth;
                    const y = chartHeight * (1 - data.history[i].pwec / 2.5);
                    
                    if (i === 0) {
                        pwecPathData += `${x},${y}`;
                    } else {
                        pwecPathData += ` L${x},${y}`;
                    }
                }
                
                pwecPath.setAttribute("d", pwecPathData);
                pwecPath.setAttribute("stroke", "#2ecc71");
                pwecPath.setAttribute("stroke-width", "2");
                pwecPath.setAttribute("fill", "none");
                pwecPath.setAttribute("opacity", showPwecLine ? "1" : "0.3");
                chart.appendChild(pwecPath);
                
                // PWEC data points with tooltips
                for (let i = 0; i < data.history.length; i += Math.max(1, Math.floor(data.history.length / 8))) {
                    const x = (data.history[i].hours_ago / timeRange) * chartWidth;
                    const pwecY = chartHeight * (1 - data.history[i].pwec / 2.5);
                    
                    const pwecPoint = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    pwecPoint.setAttribute("class", "data-point");
                    pwecPoint.setAttribute("cx", x);
                    pwecPoint.setAttribute("cy", pwecY);
                    pwecPoint.setAttribute("r", "3");
                    pwecPoint.setAttribute("fill", "#2ecc71");
                    pwecPoint.setAttribute("data-moisture", data.history[i].moisture.toFixed(1));
                    pwecPoint.setAttribute("data-pwec", data.history[i].pwec.toFixed(3));
                    pwecPoint.setAttribute("data-time", data.history[i].timestamp);
                    
                    pwecPoint.addEventListener("mouseover", function(e) {
                        const tooltip = document.getElementById('chartTooltip');
                        tooltip.innerHTML = `
                            <div>Time: ${data.history[i].timestamp}</div>
                            <div>Moisture: ${data.history[i].moisture.toFixed(1)}%</div>
                            <div>PWEC: ${data.history[i].pwec.toFixed(3)} dS/m</div>
                        `;
                        tooltip.classList.add('show');
                        
                        const rect = pwecPoint.getBoundingClientRect();
                        tooltip.style.left = (rect.left + window.scrollX + 10) + 'px';
                        tooltip.style.top = (rect.top + window.scrollY - 40) + 'px';
                    });
                    
                    pwecPoint.addEventListener("mouseout", function() {
                        document.getElementById('chartTooltip').classList.remove('show');
                    });
                    
                    chart.appendChild(pwecPoint);
                }
            }
            
            svg.appendChild(chart);
            
            // Clear and add new chart
            const container = document.getElementById('chartContainer');
            container.innerHTML = '';
            container.appendChild(svg);
        }

        function generateTimeLabelsFromData(data, timeRange) {
            if (!data.history || data.history.length === 0) {
                return ['00:00', '06:00', '12:00', '18:00', '23:59'];
            }
            
            const labels = [];
            const now = new Date();
            
            // Use actual timestamps from data for more accurate labeling
            for (let i = 0; i <= 6; i++) {
                const targetHoursAgo = (i * timeRange) / 6;
                let closestTime = "";
                let minDiff = Infinity;
                
                // Find the data point closest to this time position
                data.history.forEach(point => {
                    const diff = Math.abs(point.hours_ago - targetHoursAgo);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestTime = point.timestamp;
                    }
                });
                
                if (closestTime) {
                    labels.push(closestTime);
                } else {
                    // Fallback: calculate time based on current time
                    const time = new Date(now.getTime() - (targetHoursAgo * 3600000));
                    const hours = time.getHours().toString().padStart(2, '0');
                    const minutes = time.getMinutes().toString().padStart(2, '0');
                    labels.push(`${hours}:${minutes}`);
                }
            }
            
            return labels;
        }

        function toggleChartLine(lineType) {
            if (lineType === 'moisture') {
                showMoistureLine = !showMoistureLine;
                document.querySelector('.moisture-color').style.opacity = showMoistureLine ? "1" : "0.3";
            } else if (lineType === 'pwec') {
                showPwecLine = !showPwecLine;
                document.querySelector('.pwec-color').style.opacity = showPwecLine ? "1" : "0.3";
            }
            refreshChart();
        }

        // Initialize event listeners and system
        document.getElementById('pumpBtn').addEventListener('click', togglePump);
        document.getElementById('lightsBtn').addEventListener('click', toggleLights);
        document.getElementById('serviceBtn').addEventListener('click', toggleService);

        // Initialize the system when page loads
        window.addEventListener('load', initializeSystem);
    </script>
</body>
</html>
