<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irrigation Control System - Simulation</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #0f0f0f; 
            color: #e0e0e0; 
            padding: 10px; 
            line-height: 1.5;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a); 
            color: white; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            text-align: center; 
            border: 1px solid #333; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #27ae60, #3498db, #e74c3c);
        }
        .status-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px; 
            margin-bottom: 10px; 
        }
        .status-card { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 14px; 
            border: 1px solid #333; 
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-card:hover { 
            background: #252525; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .status-card .value {
            font-weight: bold;
            font-size: 16px;
        }
        .quick-actions { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 8px; 
            margin-bottom: 10px; 
        }
        .quick-btn { 
            padding: 15px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .quick-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); 
        }
        .btn-green { 
            background: #27ae60; 
            color: white; 
        }
        .btn-green:hover { 
            background: #2ecc71; 
        }
        .btn-red { 
            background: #c0392b; 
            color: white; 
        }
        .btn-red:hover { 
            background: #e74c3c; 
        }
        .btn-gray { 
            background: #34495e; 
            color: white; 
        }
        .btn-gray:hover { 
            background: #4a6b8a; 
        }
        .btn-blue {
            background: #2980b9;
            color: white;
        }
        .btn-blue:hover {
            background: #3498db;
        }
        .tabs { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 5px; 
            margin-bottom: 10px; 
        }
        .tab { 
            padding: 12px; 
            border: 1px solid #333; 
            background: #1a1a1a; 
            border-radius: 8px; 
            font-size: 14px; 
            color: #e0e0e0; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-align: center;
        }
        .tab:hover { 
            background: #2a2a2a; 
        }
        .tab.active { 
            background: #3498db; 
            color: white; 
            border-color: #3498db; 
        }
        .tabcontent { 
            display: none; 
            background: #1a1a1a; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border: 1px solid #333; 
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section { 
            background: #252525; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #333; 
        }
        input, select { 
            width: 100%; 
            padding: 12px; 
            margin: 5px 0; 
            border: 1px solid #444; 
            border-radius: 5px; 
            font-size: 16px; 
            background: #1a1a1a; 
            color: #e0e0e0; 
        }
        input:focus, select:focus { 
            border-color: #3498db; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .progress-bar { 
            background: #2a2a2a; 
            border-radius: 10px; 
            margin: 10px 0; 
            overflow: hidden; 
            height: 20px; 
            position: relative;
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #2ecc71, #3498db); 
            border-radius: 10px; 
            transition: width 0.5s ease; 
            position: relative;
            overflow: hidden;
        }
        .progress-fill::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 50px 50px;
            animation: move 2s linear infinite;
            overflow: hidden;
        }
        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }
        .chart-container { 
            background: #1a1a1a; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            text-align: center; 
            border: 1px solid #333; 
            overflow: auto; 
        }
        .time-input { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 5px; 
        }
        h4 { 
            color: #3498db; 
            margin-bottom: 10px; 
            border-bottom: 1px solid #333; 
            padding-bottom: 5px; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label { 
            color: #b0b0b0; 
            display: block; 
            margin-bottom: 5px; 
        }
        .input-group { 
            margin-bottom: 15px; 
        }
        .input-group label { 
            margin-bottom: 8px; 
            display: block; 
        }
        .grid-2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        .grid-3 { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px; 
        }
        .unit { 
            color: #888; 
            font-size: 12px; 
            margin-left: 5px; 
        }
        .sensor-value { 
            font-weight: bold; 
        }
        .moisture-value { color: #3498db; }
        .temp-value { color: #e74c3c; }
        .pwec-value { color: #2ecc71; }
        .ec-value { color: #9b59b6; }
        .water-value { color: #3498db; }
        .epsilon-value { color: #f39c12; }
        .phase-value { color: #1abc9c; }
        
        .legend { 
            display: flex; 
            justify-content: center; 
            margin: 10px 0; 
            flex-wrap: wrap; 
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            margin: 5px 15px; 
        }
        .legend-color { 
            width: 15px; 
            height: 15px; 
            border-radius: 3px; 
            margin-right: 5px; 
        }
        .moisture-color { 
            background: #3498db; 
        }
        .pwec-color { 
            background: #2ecc71; 
        }
        .target-line { 
            stroke: #e74c3c; 
            stroke-width: 1; 
            stroke-dasharray: 5,5; 
        }
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 15px 20px; 
            background: #2c3e50; 
            color: white; 
            border-radius: 5px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); 
            z-index: 1000; 
            transform: translateX(150%); 
            transition: transform 0.3s ease; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .notification.show { 
            transform: translateX(0); 
        }
        .notification.success { 
            background: #27ae60; 
        }
        .notification.error { 
            background: #c0392b; 
        }
        .notification.info { 
            background: #3498db; 
        }
        .notification.warning {
            background: #f39c12;
        }
        .chart-tooltip { 
            position: absolute; 
            background: rgba(0, 0, 0, 0.8); 
            color: white; 
            padding: 8px 12px; 
            border-radius: 4px; 
            font-size: 12px; 
            pointer-events: none; 
            opacity: 0; 
            transition: opacity 0.3s; 
            z-index: 100; 
        }
        .chart-tooltip.show { 
            opacity: 1; 
        }
        .data-point { 
            cursor: pointer; 
            transition: r 0.2s; 
        }
        .data-point:hover { 
            r: 5; 
        }
        .chart-controls { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .chart-zoom { 
            display: flex; 
            gap: 5px; 
        }
        .zoom-btn { 
            padding: 5px 10px; 
            background: #34495e; 
            color: white; 
            border: none; 
            border-radius: 3px; 
            cursor: pointer; 
        }
        .zoom-btn:hover { 
            background: #4a6b8a; 
        }
        
        .sensor-animation {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        
        .pump-active {
            animation: pump 0.5s infinite alternate;
        }
        
        @keyframes pump {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }
        
        .lights-active {
            animation: glow 1.5s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px #f1c40f; }
            to { box-shadow: 0 0 20px #f1c40f, 0 0 30px #f1c40f; }
        }
        
        .system-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #2ecc71;
            animation: status-pulse 2s infinite;
        }
        
        @keyframes status-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .water-droplet {
            display: inline-block;
            animation: drip 3s infinite;
            color: #3498db;
        }
        
        @keyframes drip {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(5px); opacity: 0.7; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .system-time {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>üå± Irrigation Control System - Simulation</h2>
        <div id="currentTime" class="system-time">--:--:--</div>
        <div class="system-status">
            <div class="status-indicator"></div>
            <span>System Running - All Sensors Active</span>
        </div>
    </div>
    
    <div class="status-grid">
        <div class="status-card">
            <span>Moisture: <span class="sensor-animation"></span></span>
            <span id="moisture" class="sensor-value moisture-value">--%</span>
        </div>
        <div class="status-card">
            <span>Temperature:</span>
            <span id="temperature" class="sensor-value temp-value">--¬∞C</span>
        </div>
        <div class="status-card">
            <span>PWEC:</span>
            <span id="poreEC" class="sensor-value pwec-value">-- dS/m</span>
        </div>
        <div class="status-card">
            <span>Bulk EC:</span>
            <span id="bulkEC" class="sensor-value ec-value">-- ¬µS/cm</span>
        </div>
        <div class="status-card">
            <span>Water Today: <span class="water-droplet">üíß</span></span>
            <span id="waterToday" class="sensor-value water-value">-- L</span>
        </div>
        <div class="status-card">
            <span>Epsilon B:</span>
            <span id="epsilonB" class="sensor-value epsilon-value">--</span>
        </div>
        <div class="status-card" style="grid-column: 1 / -1; text-align: center;">
            <span>Phase:</span>
            <span id="currentPhase" class="sensor-value phase-value">--</span>
        </div>
    </div>
    
    <div class="quick-actions">
        <button class="quick-btn btn-red" id="pumpBtn">
            <span>üíß</span> PUMP OFF
        </button>
        <button class="quick-btn btn-red" id="lightsBtn">
            <span>üí°</span> LIGHTS OFF
        </button>
        <button class="quick-btn btn-red" id="serviceBtn">
            <span>üîß</span> SERVICE OFF
        </button>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="openTab('control')">Control</button>
        <button class="tab" onclick="openTab('chart')">Chart</button>
        <button class="tab" onclick="openTab('wifi')">WiFi</button>
        <button class="tab" onclick="openTab('settings')">Settings</button>
        <button class="tab" onclick="openTab('time')">Time</button>
    </div>
    
    <div id="control" class="tabcontent" style="display:block">
        <div class="section">
            <h4>üåø Moisture Control</h4>
            <div class="input-group">
                <label>Current Moisture: <span id="controlMoisture" class="sensor-value moisture-value">--%</span></label>
                <label>Highest Moisture: <span id="controlHighest" class="sensor-value moisture-value">--%</span></label>
                <label>Target Moisture: <span id="controlTarget" class="sensor-value moisture-value">--%</span></label>
            </div>
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <div style="text-align: center;" id="progressText">0%</div>
            <div class="input-group">
                <label for="setHighestValue">Set Highest Moisture Value (%)</label>
                <input type="number" id="setHighestValue" placeholder="Enter value" step="0.1">
            </div>
            <div class="grid-2">
                <button class="quick-btn btn-green" onclick="setHighestMoisture()">Set Highest</button>
                <button class="quick-btn btn-red" onclick="resetHighestMoisture()">Reset to 0</button>
            </div>
        </div>

        <div class="section">
            <h4>üå± Growth Mode</h4>
            <div class="input-group">
                <label>Current Mode: <span id="currentMode" class="sensor-value">--</span></label>
                <label>Irrigation Phase: <span id="currentIrrigationPhase" class="sensor-value phase-value">--</span></label>
            </div>
            <div class="grid-2">
                <button class="quick-btn btn-green" onclick="switchToVegetative()">Vegetative</button>
                <button class="quick-btn btn-green" onclick="switchToGenerative()">Generative</button>
            </div>
        </div>
    </div>
    
    <div id="chart" class="tabcontent">
        <div class="section">
            <h4>üìä Soil Analytics Chart</h4>
            <div class="chart-controls">
                <div>
                    <label for="timeRange">Select Time Range</label>
                    <select id="timeRange" onchange="refreshChart()">
                        <option value="24">24 Hours</option>
                        <option value="12">12 Hours</option>
                        <option value="6">6 Hours</option>
                        <option value="2">2 Hours</option>
                        <option value="1">1 Hour</option>
                    </select>
                </div>
                <div class="chart-zoom">
                    <button class="zoom-btn" onclick="zoomChart(0.5)">Zoom -</button>
                    <button class="zoom-btn" onclick="zoomChart(2)">Zoom +</button>
                    <button class="zoom-btn" onclick="resetZoom()">Reset</button>
                </div>
            </div>
            <button class="quick-btn btn-green" onclick="refreshChart()" style="width: 100%;">Refresh Chart</button>
        </div>
        <div class="chart-container" id="chartContainer">
            <div style="padding: 50px; color: #666;">Loading chart data...</div>
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color moisture-color"></div>
                <span>Moisture (%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color pwec-color"></div>
                <span>PWEC (dS/m)</span>
            </div>
            <div class="legend-item">
                <div style="background: #e74c3c; width: 15px; height: 2px; margin-right: 5px;"></div>
                <span>Target Moisture (85%)</span>
            </div>
        </div>
    </div>
    
    <div id="wifi" class="tabcontent">
        <div class="section">
            <h4>üì∂ Current Status</h4>
            <div class="input-group">
                <label>WiFi Mode: <span id="currentWifiMode" class="sensor-value">AP</span></label>
                <label>Connection Status: <span id="currentWifiStatus" class="sensor-value">AP: Irrigation_System</span></label>
                <label>IP Address: <span id="currentIP" class="sensor-value">192.168.4.1</span></label>
            </div>
        </div>
        
        <div class="section">
            <h4>üåê Network Setup</h4>
            <div class="input-group">
                <label for="wifi_ssid">WiFi Name (SSID)</label>
                <input type="text" id="wifi_ssid" placeholder="Enter WiFi name">
            </div>
            <div class="input-group">
                <label for="wifi_password">WiFi Password</label>
                <input type="password" id="wifi_password" placeholder="Enter password">
            </div>
            <button class="quick-btn btn-green" onclick="scanNetworks()" style="width: 100%; margin-bottom: 10px;">Scan Networks</button>
            <div id="scanResults" style="border: 1px solid #444; padding: 10px; border-radius: 5px; background: #1a1a1a;">
                <div>No networks scanned yet</div>
            </div>
            <div class="grid-2" style="margin-top: 10px;">
                <button class="quick-btn btn-green" onclick="saveWiFiConfig()">Save & Connect</button>
                <button class="quick-btn btn-gray" onclick="switchToAPMode()">AP Mode</button>
            </div>
        </div>
    </div>

    <div id="settings" class="tabcontent">
        <div class="section">
            <h4>‚öôÔ∏è Basic Settings</h4>
            <div class="input-group">
                <label for="moisture_target">Moisture Target <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="moisture_target" value="85.0">
            </div>
            <div class="input-group">
                <label for="max_dryback">Max Dryback <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="max_dryback" value="45.0">
            </div>
            <div class="input-group">
                <label for="time_between_shots">Time Between Shots <span class="unit">(minutes)</span></label>
                <input type="number" step="0.1" id="time_between_shots" value="15.0">
            </div>
            <div class="input-group">
                <label for="pump_flow_rate">Pump Flow Rate <span class="unit">(L/hour)</span></label>
                <input type="number" step="0.1" id="pump_flow_rate" value="10.0">
            </div>
        </div>

        <div class="section">
            <h4>üíß Shot Settings</h4>
            <div class="input-group">
                <label for="p1_shot">P1 Shot Duration <span class="unit">(seconds)</span></label>
                <input type="number" step="0.1" id="p1_shot" value="150.0">
            </div>
            <div class="input-group">
                <label for="p1_dryback">P1 Dryback Threshold <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="p1_dryback" value="0.0">
            </div>
            <div class="input-group">
                <label for="p2_shot">P2 Shot Duration <span class="unit">(seconds)</span></label>
                <input type="number" step="0.1" id="p2_shot" value="85.0">
            </div>
            <div class="input-group">
                <label for="p2_dryback">P2 Dryback Threshold <span class="unit">(%)</span></label>
                <input type="number" step="0.1" id="p2_dryback" value="6.0">
            </div>
        </div>

        <div class="section">
            <h4>‚è∞ Delay Settings</h4>
            <div class="input-group">
                <label for="delay_before_veg">Delay Before Veg Lights Off <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="delay_before_veg" value="1.0">
            </div>
            <div class="input-group">
                <label for="delay_after_veg">Delay After Veg Lights On <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="delay_after_veg" value="1.0">
            </div>
            <div class="input-group">
                <label for="delay_before_gen">Delay Before Gen Lights Off <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="delay_before_gen" value="2.0">
            </div>
            <div class="input-group">
                <label for="delay_after_gen">Delay After Gen Lights On <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="delay_after_gen" value="2.0">
            </div>
        </div>

        <div class="section">
            <h4>üî¨ Advanced Settings</h4>
            <div class="input-group">
                <label for="epsilon_offset">Epsilon Offset <span class="unit">(dimensionless)</span></label>
                <input type="number" step="0.01" id="epsilon_offset" value="4.1">
            </div>
            <div class="input-group">
                <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="service_mode" style="margin-right: 10px;">
                    Service Mode
                </label>
            </div>
        </div>

        <button class="quick-btn btn-green" onclick="saveAllSettings()" style="width: 100%;">Save All Settings</button>
    </div>

    <div id="time" class="tabcontent">
        <div class="section">
            <h4>üïí Current Time</h4>
            <div id="currentTimeDisplay" class="system-time" style="text-align: center; font-size: 24px; font-weight: bold; color: #2ecc71;">--:--:--</div>
        </div>

        <div class="section">
            <h4>‚è±Ô∏è Set Manual Time</h4>
            <div class="input-group">
                <label>Set Time Manually</label>
                <div class="time-input">
                    <div>
                        <label for="setHour">Hour</label>
                        <input type="number" id="setHour" min="0" max="23" value="12" placeholder="Hour">
                    </div>
                    <div>
                        <label for="setMinute">Minute</label>
                        <input type="number" id="setMinute" min="0" max="59" value="0" placeholder="Minute">
                    </div>
                    <div>
                        <label for="setSecond">Second</label>
                        <input type="number" id="setSecond" min="0" max="59" value="0" placeholder="Second">
                    </div>
                </div>
            </div>
            <button class="quick-btn btn-green" onclick="setTime()" style="width: 100%;">Set Time</button>
        </div>

        <div class="section">
            <h4>üí° Light Schedule</h4>
            <div class="input-group">
                <label>Lights On Time</label>
                <div class="grid-2">
                    <div>
                        <label for="lights_hour">Hour</label>
                        <input type="number" id="lights_hour" min="0" max="23" value="9" placeholder="Hour">
                    </div>
                    <div>
                        <label for="lights_minute">Minute</label>
                        <input type="number" id="lights_minute" min="0" max="59" value="0" placeholder="Minute">
                    </div>
                </div>
            </div>
            <div class="input-group">
                <label for="dark_hours">Dark Hours Duration <span class="unit">(hours)</span></label>
                <input type="number" step="0.1" id="dark_hours" value="12.0" placeholder="Dark Hours">
            </div>
            <div class="input-group">
                <label>Calculated Lights Off Time: <span class="sensor-value">21:00</span></label>
            </div>
            <button class="quick-btn btn-green" onclick="saveTimeSettings()" style="width: 100%;">Save Light Schedule</button>
        </div>
    </div>
    
    <div id="notification" class="notification">
        <span>üîî</span>
        <span id="notificationText">Notification message</span>
    </div>
    <div id="chartTooltip" class="chart-tooltip"></div>

    <script>
        // System state simulation
        const systemState = {
            moisture: 72.5,
            temperature: 22.3,
            bulkEC: 1250,
            poreEC: 1.25,
            epsilonB: 12.8,
            highestMoisture: 85.0,
            pumpOn: false,
            lightsOn: false,
            serviceMode: false,
            maintenance: false,
            generative: false,
            moistureTarget: 85.0,
            appliedWater: 5.7,
            currentSessionWater: 0,
            wateringActive: false,
            currentPhase: "P1",
            currentTime: "14:23:45",
            wifiMode: "AP",
            wifiStatus: "AP: Irrigation_System",
            ipAddress: "192.168.4.1"
        };

        let chartScale = 1;
        let currentTab = 'control';
        let chartData = [];
        let simulatedTime = new Date();
        simulatedTime.setHours(14, 23, 45);
        
        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            startSensorSimulation();
            startTimeSimulation();
            generateChartData();
            refreshChart();
            
            // Add event listeners
            document.getElementById('pumpBtn').addEventListener('click', togglePump);
            document.getElementById('lightsBtn').addEventListener('click', toggleLights);
            document.getElementById('serviceBtn').addEventListener('click', toggleService);
        });
        
        function openTab(tabName) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.currentTarget.classList.add('active');
            currentTab = tabName;
            if (tabName === 'chart') refreshChart();
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateStatus() {
            // Update all status displays with current system state
            document.getElementById('currentTime').textContent = systemState.currentTime;
            document.getElementById('moisture').textContent = systemState.moisture.toFixed(1) + '%';
            document.getElementById('temperature').textContent = systemState.temperature.toFixed(1) + '¬∞C';
            document.getElementById('poreEC').textContent = systemState.poreEC.toFixed(3) + ' dS/m';
            document.getElementById('bulkEC').textContent = systemState.bulkEC.toFixed(0) + ' ¬µS/cm';
            document.getElementById('waterToday').textContent = systemState.appliedWater.toFixed(1) + ' L';
            document.getElementById('epsilonB').textContent = systemState.epsilonB.toFixed(1);
            document.getElementById('currentPhase').textContent = systemState.currentPhase;
            document.getElementById('currentTimeDisplay').textContent = systemState.currentTime;
            
            document.getElementById('controlMoisture').textContent = systemState.moisture.toFixed(1) + '%';
            document.getElementById('controlHighest').textContent = systemState.highestMoisture.toFixed(1) + '%';
            document.getElementById('controlTarget').textContent = systemState.moistureTarget.toFixed(1) + '%';
            document.getElementById('currentMode').textContent = systemState.generative ? 'Generative' : 'Vegetative';
            document.getElementById('currentIrrigationPhase').textContent = systemState.currentPhase;
            
            const progress = Math.min(100, Math.max(0, (systemState.highestMoisture / systemState.moistureTarget) * 100));
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress.toFixed(0) + '%';
            
            // Update button states
            const pumpBtn = document.getElementById('pumpBtn');
            const lightsBtn = document.getElementById('lightsBtn');
            const serviceBtn = document.getElementById('serviceBtn');
            
            pumpBtn.textContent = systemState.pumpOn ? 'üíß PUMP ON' : 'üíß PUMP OFF';
            lightsBtn.textContent = systemState.lightsOn ? 'üí° LIGHTS ON' : 'üí° LIGHTS OFF';
            serviceBtn.textContent = systemState.serviceMode ? 'üîß SERVICE ON' : 'üîß SERVICE OFF';
            
            pumpBtn.className = systemState.pumpOn ? 'quick-btn btn-green pump-active' : 'quick-btn btn-red';
            lightsBtn.className = systemState.lightsOn ? 'quick-btn btn-green lights-active' : 'quick-btn btn-red';
            serviceBtn.className = systemState.serviceMode ? 'quick-btn btn-green' : 'quick-btn btn-red';
            
            // Update settings form
            document.getElementById('moisture_target').value = systemState.moistureTarget;
            document.getElementById('service_mode').checked = systemState.serviceMode;
            
            // Update WiFi status
            document.getElementById('currentWifiMode').textContent = systemState.wifiMode;
            document.getElementById('currentWifiStatus').textContent = systemState.wifiStatus;
            document.getElementById('currentIP').textContent = systemState.ipAddress;
        }
        
        function startSensorSimulation() {
            // Simulate sensor data changes
            setInterval(() => {
                // Random small fluctuations in sensor readings
                systemState.moisture = Math.max(40, Math.min(95, systemState.moisture + (Math.random() - 0.5) * 0.5));
                systemState.temperature = Math.max(18, Math.min(28, systemState.temperature + (Math.random() - 0.5) * 0.1));
                systemState.bulkEC = Math.max(800, Math.min(2000, systemState.bulkEC + (Math.random() - 0.5) * 10));
                systemState.poreEC = Math.max(0.5, Math.min(2.5, systemState.poreEC + (Math.random() - 0.5) * 0.05));
                systemState.epsilonB = Math.max(10, Math.min(15, systemState.epsilonB + (Math.random() - 0.5) * 0.1));
                
                // Update highest moisture if needed
                if (systemState.moisture > systemState.highestMoisture) {
                    systemState.highestMoisture = systemState.moisture;
                }
                
                // Simulate irrigation logic
                if (!systemState.serviceMode && !systemState.wateringActive) {
                    const moistureDiff = systemState.moistureTarget - systemState.moisture;
                    
                    if (moistureDiff > 5 && Math.random() > 0.7) {
                        // Simulate automatic watering
                        startWatering(30);
                    }
                }
                
                // Update water usage if watering is active
                if (systemState.wateringActive) {
                    systemState.currentSessionWater += 0.1;
                }
                
                updateStatus();
            }, 2000);
        }
        
        function startTimeSimulation() {
            // Simulate time progression
            setInterval(() => {
                simulatedTime.setSeconds(simulatedTime.getSeconds() + 1);
                
                const hours = simulatedTime.getHours().toString().padStart(2, '0');
                const minutes = simulatedTime.getMinutes().toString().padStart(2, '0');
                const seconds = simulatedTime.getSeconds().toString().padStart(2, '0');
                
                systemState.currentTime = `${hours}:${minutes}:${seconds}`;
                
                // Update lights based on time (9:00 to 21:00)
                const currentHour = simulatedTime.getHours();
                systemState.lightsOn = currentHour >= 9 && currentHour < 21;
                
                updateStatus();
            }, 1000);
        }
        
        function generateChartData() {
            // Generate simulated historical data
            chartData = [];
            const now = new Date();
            
            for (let i = 143; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 10 * 60 * 1000); // 10 minute intervals
                const hours = time.getHours().toString().padStart(2, '0');
                const minutes = time.getMinutes().toString().padStart(2, '0');
                
                // Generate realistic moisture data with some variation
                const baseMoisture = 70 + Math.sin(i / 20) * 15;
                const moisture = Math.max(40, Math.min(95, baseMoisture + (Math.random() - 0.5) * 5));
                
                // Generate correlated PWEC data
                const pwec = Math.max(0.5, Math.min(2.5, 1.5 + (moisture - 70) / 30 + (Math.random() - 0.5) * 0.2));
                
                chartData.push({
                    hours_ago: (143 - i) * 10 / 60,
                    timestamp: `${hours}:${minutes}`,
                    moisture: moisture,
                    pwec: pwec
                });
            }
        }
        
        function togglePump() {
            systemState.pumpOn = !systemState.pumpOn;
            
            if (systemState.pumpOn) {
                startWatering(30);
                showNotification('Pump activated - Watering started', 'success');
            } else {
                systemState.wateringActive = false;
                systemState.appliedWater += systemState.currentSessionWater;
                systemState.currentSessionWater = 0;
                showNotification('Pump deactivated', 'info');
            }
            
            updateStatus();
        }
        
        function toggleLights() {
            systemState.lightsOn = !systemState.lightsOn;
            showNotification(`Lights ${systemState.lightsOn ? 'activated' : 'deactivated'}`, 'info');
            updateStatus();
        }
        
        function toggleService() {
            systemState.serviceMode = !systemState.serviceMode;
            showNotification(`Service mode ${systemState.serviceMode ? 'enabled' : 'disabled'}`, 'warning');
            updateStatus();
        }
        
        function startWatering(duration) {
            systemState.wateringActive = true;
            systemState.currentSessionWater = 0;
            
            setTimeout(() => {
                if (systemState.wateringActive) {
                    systemState.wateringActive = false;
                    systemState.appliedWater += systemState.currentSessionWater;
                    systemState.currentSessionWater = 0;
                    systemState.pumpOn = false;
                    
                    // Simulate moisture increase after watering
                    systemState.moisture = Math.min(95, systemState.moisture + 15);
                    if (systemState.moisture > systemState.highestMoisture) {
                        systemState.highestMoisture = systemState.moisture;
                    }
                    
                    showNotification('Watering completed', 'success');
                    updateStatus();
                }
            }, duration * 1000);
        }
        
        function switchToVegetative() {
            systemState.generative = false;
            showNotification('Switched to Vegetative mode', 'success');
            updateStatus();
        }
        
        function switchToGenerative() {
            systemState.generative = true;
            showNotification('Switched to Generative mode', 'success');
            updateStatus();
        }
        
        function setHighestMoisture() {
            const value = parseFloat(document.getElementById('setHighestValue').value);
            if (!isNaN(value)) {
                systemState.highestMoisture = value;
                showNotification(`Highest moisture set to ${value}%`, 'success');
                updateStatus();
            }
        }
        
        function resetHighestMoisture() {
            systemState.highestMoisture = 0;
            showNotification('Highest moisture reset to 0%', 'info');
            updateStatus();
        }
        
        function setTime() {
            const hour = parseInt(document.getElementById('setHour').value) || 0;
            const minute = parseInt(document.getElementById('setMinute').value) || 0;
            const second = parseInt(document.getElementById('setSecond').value) || 0;
            
            simulatedTime.setHours(hour, minute, second);
            
            const hours = simulatedTime.getHours().toString().padStart(2, '0');
            const minutes = simulatedTime.getMinutes().toString().padStart(2, '0');
            const seconds = simulatedTime.getSeconds().toString().padStart(2, '0');
            
            systemState.currentTime = `${hours}:${minutes}:${seconds}`;
            
            showNotification(`Time set to ${systemState.currentTime}`, 'success');
            updateStatus();
        }
        
        function saveTimeSettings() {
            const lights_hour = parseInt(document.getElementById('lights_hour').value) || 9;
            const lights_minute = parseInt(document.getElementById('lights_minute').value) || 0;
            const dark_hours = parseFloat(document.getElementById('dark_hours').value) || 12.0;
            
            // Calculate lights off time
            const light_hours = 24.0 - dark_hours;
            const lights_off_total_minutes = (lights_hour * 60 + lights_minute) + Math.round(light_hours * 60);
            const lights_off_hour = Math.floor(lights_off_total_minutes / 60) % 24;
            const lights_off_minute = lights_off_total_minutes % 60;
            
            const lights_off_time = `${lights_off_hour.toString().padStart(2, '0')}:${lights_off_minute.toString().padStart(2, '0')}`;
            
            document.querySelector('#time .input-group:last-child label:last-child .sensor-value').textContent = lights_off_time;
            
            showNotification('Light schedule saved!', 'success');
        }
        
        function scanNetworks() {
            document.getElementById('scanResults').innerHTML = '<p style="padding: 10px; color: #888;">Scanning...</p>';
            
            // Simulate network scanning delay
            setTimeout(() => {
                const networks = [
                    { ssid: 'HomeWiFi', rssi: -45 },
                    { ssid: 'Office_Network', rssi: -62 },
                    { ssid: 'NeighborWiFi', rssi: -78 },
                    { ssid: 'GuestNetwork', rssi: -68 },
                    { ssid: 'IoT_Devices', rssi: -55 }
                ];
                
                let html = '';
                networks.forEach(network => {
                    const strength = Math.min(Math.max(2 * (network.rssi + 100), 0), 100);
                    html += `<div style="padding: 10px; border-bottom: 1px solid #444; cursor: pointer;" 
                             onclick="document.getElementById('wifi_ssid').value='${network.ssid}'">
                              <strong>${network.ssid}</strong><br>
                              <small>Signal: ${strength}%</small>
                            </div>`;
                });
                document.getElementById('scanResults').innerHTML = html;
                showNotification('Found ' + networks.length + ' networks', 'info');
            }, 2000);
        }
        
        function saveWiFiConfig() {
            const ssid = document.getElementById('wifi_ssid').value;
            const password = document.getElementById('wifi_password').value;
            
            if (ssid) {
                systemState.wifiMode = "STA";
                systemState.wifiStatus = `Connected to ${ssid}`;
                systemState.ipAddress = "192.168.1.105";
                
                showNotification(`Connected to ${ssid}`, 'success');
                updateStatus();
            } else {
                showNotification('Please enter a WiFi name', 'error');
            }
        }
        
        function switchToAPMode() {
            systemState.wifiMode = "AP";
            systemState.wifiStatus = "AP: Irrigation_System";
            systemState.ipAddress = "192.168.4.1";
            
            showNotification('Switched to AP mode', 'info');
            updateStatus();
        }
        
        function saveAllSettings() {
            systemState.moistureTarget = parseFloat(document.getElementById('moisture_target').value) || 85.0;
            systemState.serviceMode = document.getElementById('service_mode').checked;
            
            showNotification('Settings saved successfully!', 'success');
            updateStatus();
        }

        // Chart functions (simplified for static version)
        function refreshChart() {
            const timeRange = parseInt(document.getElementById('timeRange').value);
            generateSimpleChart(timeRange);
            showNotification('Chart updated for ' + timeRange + ' hours', 'success');
        }
        
        function generateSimpleChart(timeRange) {
            const container = document.getElementById('chartContainer');
            const width = 600;
            const height = 350;
            
            // Filter data based on time range
            const filteredData = chartData.filter(point => point.hours_ago <= timeRange);
            
            // Create simple SVG chart
            let svg = `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" style="background:#1a1a1a; border-radius:5px;">`;
            
            // Add grid
            for (let i = 0; i <= 4; i++) {
                const y = i * (height / 4);
                svg += `<line x1="0" y1="${y}" x2="${width}" y2="${y}" stroke="#333" stroke-width="1" />`;
            }
            
            for (let i = 0; i <= 6; i++) {
                const x = i * (width / 6);
                svg += `<line x1="${x}" y1="0" x2="${x}" y2="${height}" stroke="#333" stroke-width="1" />`;
            }
            
            // Add target line
            const targetY = height * (1 - 0.85);
            svg += `<line x1="0" y1="${targetY}" x2="${width}" y2="${targetY}" stroke="#e74c3c" stroke-width="1" stroke-dasharray="5,5" />`;
            svg += `<text x="${width - 40}" y="${targetY - 5}" fill="#e74c3c" font-size="9">Target 85%</text>`;
            
            // Add moisture line
            if (filteredData.length > 0) {
                let moisturePath = `M`;
                filteredData.forEach((point, i) => {
                    const x = (point.hours_ago / timeRange) * width;
                    const y = height * (1 - point.moisture / 100);
                    
                    if (i === 0) {
                        moisturePath += `${x},${y}`;
                    } else {
                        moisturePath += ` L${x},${y}`;
                    }
                });
                
                svg += `<path d="${moisturePath}" stroke="#3498db" stroke-width="2" fill="none" />`;
                
                // Add PWEC line
                let pwecPath = `M`;
                filteredData.forEach((point, i) => {
                    const x = (point.hours_ago / timeRange) * width;
                    const y = height * (1 - point.pwec / 2.5);
                    
                    if (i === 0) {
                        pwecPath += `${x},${y}`;
                    } else {
                        pwecPath += ` L${x},${y}`;
                    }
                });
                
                svg += `<path d="${pwecPath}" stroke="#2ecc71" stroke-width="2" fill="none" />`;
                
                // Add some data points
                for (let i = 0; i < filteredData.length; i += Math.max(1, Math.floor(filteredData.length / 8))) {
                    const point = filteredData[i];
                    const x = (point.hours_ago / timeRange) * width;
                    const moistureY = height * (1 - point.moisture / 100);
                    const pwecY = height * (1 - point.pwec / 2.5);
                    
                    svg += `<circle cx="${x}" cy="${moistureY}" r="3" fill="#3498db" class="data-point" 
                             data-moisture="${point.moisture.toFixed(1)}" data-pwec="${point.pwec.toFixed(3)}" data-time="${point.timestamp}" />`;
                    svg += `<circle cx="${x}" cy="${pwecY}" r="3" fill="#2ecc71" class="data-point" 
                             data-moisture="${point.moisture.toFixed(1)}" data-pwec="${point.pwec.toFixed(3)}" data-time="${point.timestamp}" />`;
                }
            }
            
            // Add axes
            for (let i = 0; i <= 4; i++) {
                const value = 100 - i * 25;
                const y = i * (height / 4);
                svg += `<text x="-5" y="${y + 3}" fill="#3498db" font-size="10" text-anchor="end">${value}%</text>`;
            }
            
            for (let i = 0; i <= 4; i++) {
                const value = 2.5 - i * 0.5;
                const y = i * (height / 4);
                svg += `<text x="${width + 10}" y="${y + 3}" fill="#2ecc71" font-size="10">${value.toFixed(1)}</text>`;
            }
            
            // Add time labels
            const timeLabels = generateTimeLabels(timeRange);
            for (let i = 0; i <= 6; i++) {
                const x = i * (width / 6);
                svg += `<text x="${x}" y="${height + 15}" fill="#888" font-size="10" text-anchor="middle">${timeLabels[i]}</text>`;
            }
            
            svg += `</svg>`;
            
            container.innerHTML = svg;
            
            // Add event listeners to data points
            document.querySelectorAll('.data-point').forEach(point => {
                point.addEventListener('mouseover', showDataPointTooltip);
                point.addEventListener('mouseout', hideDataPointTooltip);
            });
        }
        
        function generateTimeLabels(timeRange) {
            const now = new Date();
            const labels = [];
            
            for (let i = 6; i >= 0; i--) {
                const time = new Date(now.getTime() - (i * timeRange * 3600000 / 6));
                const hours = time.getHours().toString().padStart(2, '0');
                const minutes = time.getMinutes().toString().padStart(2, '0');
                labels.push(`${hours}:${minutes}`);
            }
            
            return labels;
        }
        
        function showDataPointTooltip(event) {
            const point = event.target;
            const moisture = point.getAttribute('data-moisture');
            const pwec = point.getAttribute('data-pwec');
            const timestamp = point.getAttribute('data-time');
            
            const tooltip = document.getElementById('chartTooltip');
            tooltip.innerHTML = `
                <div>Time: ${timestamp}</div>
                <div>Moisture: ${moisture}%</div>
                <div>PWEC: ${pwec} dS/m</div>
            `;
            tooltip.classList.add('show');
            
            const rect = point.getBoundingClientRect();
            tooltip.style.left = (rect.left + window.scrollX + 10) + 'px';
            tooltip.style.top = (rect.top + window.scrollY - 40) + 'px';
        }

        function hideDataPointTooltip() {
            const tooltip = document.getElementById('chartTooltip');
            tooltip.classList.remove('show');
        }
        
        function zoomChart(factor) {
            chartScale *= factor;
            const svg = document.querySelector('#chartContainer svg');
            if (svg) {
                svg.style.transform = `scale(${chartScale})`;
                svg.style.transformOrigin = 'center center';
            }
        }
        
        function resetZoom() {
            chartScale = 1;
            const svg = document.querySelector('#chartContainer svg');
            if (svg) {
                svg.style.transform = 'scale(1)';
            }
        }
    </script>
</body>
</html>
